<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard – Auditoria LAMIC</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --primary: #0b2545;
    --primary-light: #133b5c;
    --accent: #2563eb;
    --bg: #f3f4f6;
    --card-bg: #ffffff;
    --text: #1f2937;
    --text-light: #6b7280;
    --border: #e5e7eb;
    
    /* Cores de Status */
    --c-blue: #3b82f6;
    --c-green: #22c55e;
    --c-red: #ef4444;
    --c-orange: #f97316;
    --c-yellow: #eab308;
    --c-purple: #a855f7;
    --c-default: #6b7280;
    
    /* Indicadores de prazo */
    --ind-green: #22c55e;
    --ind-yellow: #eab308;
    --ind-red: #ef4444;
}

*{box-sizing:border-box}
body{margin:0;font-family:'Inter',sans-serif;display:flex;height:100vh;background:var(--bg);color:var(--text);overflow:hidden}

/* SIDEBAR */
.sidebar{width:260px;background:var(--primary);color:#fff;padding:32px 0;flex-shrink:0;display:flex;flex-direction:column}
.sidebar-logo{text-align:center;font-size:22px;font-weight:700;margin-bottom:40px;letter-spacing:-0.5px}
.sidebar button{width:100%;background:none;border:none;color:#cfd8e3;padding:16px 28px;text-align:left;font-size:15px;cursor:pointer;display:flex;gap:14px;align-items:center;transition:0.2s}
.sidebar button:hover{background:rgba(255,255,255,0.05);color:#fff}
.sidebar button.active{background:rgba(255,255,255,0.15);color:#fff;font-weight:600;border-right:4px solid var(--accent)}

.sidebar-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 8px 20px; }

/* MAIN LAYOUT */
.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* HEADER */
.header{background:#fff;padding:20px 40px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;height:80px}
.title-area h1{margin:0;font-size:24px;font-weight:700;color:var(--primary)}
.title-area small{color:var(--text-light);font-size:14px}

.btn-primary{
    background:var(--primary-light);color:#fff;border:none;padding:12px 24px;border-radius:10px;
    font-size:14px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:8px;
    transition:transform 0.1s, background 0.2s;box-shadow:0 4px 12px rgba(11,37,69,0.15)
}
.btn-primary:hover{background:var(--primary);transform:translateY(-1px)}
.btn-primary:active{transform:translateY(0)}

/* CONTENT AREA */
.content{flex:1;padding:30px 40px;overflow-y:auto;display:flex;flex-direction:column;gap:24px}

/* FILTERS BAR */
.filters-bar{
    background:#fff;padding:20px;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,0.03);
    display:flex;gap:16px;flex-wrap:wrap;align-items:center;border:1px solid var(--border);
    justify-content: space-between; /* Ajustado para mover o botão para a direita */
}
.filter-controls { display: flex; flex-wrap: wrap; gap: 16px; }
.filter-group{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.filter-input{
    padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:13px;
    color:var(--text);outline:none;background:#f9fafb;transition:0.2s;min-width:140px
}
.filter-input:focus{border-color:var(--primary-light);background:#fff;box-shadow:0 0 0 3px rgba(19,59,92,0.1)}

/* Date Filter Wrappers */
.date-controls { display: flex; gap: 8px; align-items: center; background: #f9fafb; padding: 4px; border: 1px solid var(--border); border-radius: 8px; }
.date-controls select, .date-controls input { border: 1px solid transparent; background: transparent; font-size: 13px; color: var(--text); padding: 5px; border-radius: 4px; outline: none; }
.date-controls select:hover, .date-controls input:hover { background: #e5e7eb; }
.date-controls input[type="date"] { font-family: inherit; }

.btn-clear{padding:8px 16px;background:transparent;border:1px solid var(--border);color:var(--text-light);border-radius:8px;cursor:pointer;font-size:13px}
.btn-clear:hover{background:#f3f4f6;color:var(--text)}

/* CARDS GRID (FIXED SIZE) */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, 296px);
    gap: 24px;
    justify-content: start;
    padding-bottom: 40px;
}

.card {
    background: #fff;
    width: 296px;
    border-radius: 16px;
    padding: 20px;
    position: relative;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 200px;
}
.card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

/* Indicador lateral (Prazo) */
.card::before {
    content: ''; position: absolute; left: 0; top: 16px; bottom: 16px; width: 4px; border-radius: 0 4px 4px 0;
}
.card.ind-green::before { background: var(--ind-green); }
.card.ind-yellow::before { background: var(--ind-yellow); }
.card.ind-red::before { background: var(--ind-red); }

.card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: -10px; padding-left: 10px; }
.card-header h4 { margin: 0; font-size: 16px; font-weight: 600; color: var(--primary); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.card-actions { display: flex; gap: 8px; opacity: 0; transition: 0.2s; }
.card:hover .card-actions { opacity: 1; }
.card-actions i { font-size: 14px; color: var(--text-light); padding: 4px; border-radius: 4px; }
.card-actions i:hover { background: #f3f4f6; color: var(--primary); }

.card-body { padding-left: 10px; flex: 0.1; display: flex; flex-direction: column; gap: 4px; font-size: 13px; color: var(--text-light); }
.card-info-row { display: flex; align-items: center; gap: 8px; }
.card-info-row i { width: 16px; text-align: center; color: #9ca3af; }

/* Tag de Status com Cor */
.tag { 
    padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; 
    text-transform: uppercase; letter-spacing: 0.5px; width: fit-content; 
    color: #fff; /* Texto sempre branco */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* --- NOVO DASHBOARD STYLES --- */
#dashboardContent { 
    display: none; 
    flex-direction: column; 
    gap: 30px; 
    padding-bottom: 40px; 
}
.summary-cards { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap: 20px; 
}
.summary-card {
    background: var(--card-bg);
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
.summary-card .icon-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}
.summary-card .icon-header i {
    font-size: 24px;
    color: var(--accent);
    padding: 10px;
    border-radius: 8px;
    background: #eff6ff;
}
.summary-card p {
    margin: 0;
    font-size: 14px;
    color: var(--text-light);
    font-weight: 500;
}
.summary-card h2 {
    margin: 4px 0 0;
    font-size: 32px;
    font-weight: 700;
    color: var(--primary);
}

.dashboard-charts {
    display: grid;
    grid-template-columns: 2fr 1fr; /* Dois gráficos maiores e um menor */
    gap: 30px;
}

.chart-card {
    background: var(--card-bg);
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
    min-height: 400px;
}
.chart-card h3 {
    margin: 0 0 16px;
    color: var(--primary);
    font-size: 18px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 12px;
}

.chart-content {
    /* Flex para conter a lista de dados e o gráfico real (se implementado) */
    display: flex;
    flex-direction: column;
    height: calc(100% - 40px); /* Ajusta para o h3 */
    justify-content: center;
    align-items: center;
    font-size: 14px;
    color: var(--text-light);
}

.chart-list {
    width: 100%;
    list-style: none;
    padding: 0;
    margin: 0;
}

/* Novo estilo para listas com barras (G1, G2, G3) */
.chart-list li {
    display: flex;
    flex-direction: column; /* Coloca a barra abaixo do texto */
    padding: 10px 0;
    border-bottom: 1px dashed var(--border);
    position: relative; /* Para posicionar a barra de fundo */
}
.chart-list li:last-child {
    border-bottom: none;
}
.chart-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
    z-index: 10; /* Mantém o texto acima da barra */
    position: relative;
}

.chart-list .status-info {
    display: flex;
    align-items: center;
    font-weight: 600;
    color: var(--text);
}
.chart-list .value {
    font-weight: 700;
    color: var(--primary);
}
.chart-list .percent {
    font-weight: 500;
    color: var(--text-light);
    margin-left: 8px;
}
.chart-list .deadline-info {
    font-size: 15px;
    font-weight: 700;
}

/* Estilo para a barra de gráfico */
.chart-bar {
    height: 12px;
    background: #e5e7eb;
    border-radius: 6px;
    overflow: hidden;
    position: relative;
    margin-top: 5px;
    z-index: 5;
}
.chart-bar-fill {
    height: 100%;
    background-color: var(--accent); /* Cor padrão, será sobrescrita */
    border-radius: 6px;
    transition: width 0.5s ease-out;
}

/* BACKUP VIEW */
#backupContent { display: none; flex-direction: column; gap: 30px; align-items: center; justify-content: center; height: 100%; text-align: center; }
.backup-card { background: #fff; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid var(--border); width: 100%; max-width: 500px; }
.backup-actions { display: flex; gap: 20px; justify-content: center; margin-top: 24px; }
.btn-large { padding: 16px 32px; font-size: 16px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; border: none; font-weight: 600; transition: 0.2s; }
.btn-export { background: var(--primary); color: #fff; }
.btn-export:hover { background: var(--primary-light); transform: translateY(-2px); }
.btn-import { background: #fff; color: var(--text); border: 2px solid var(--border); }
.btn-import:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }

/* MODAL FORM */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(2px);justify-content:center;align-items:center;z-index:1000}
.modal-content{background:#fff;padding:32px;border-radius:24px;width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25)}
.modal-header{margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.modal-header h3{margin:0;color:var(--primary);font-size:20px}

.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.full-width{grid-column:1 / -1}

.field-group{display:flex;flex-direction:column;gap:6px}
.field-group label{font-size:12px;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:0.5px}
.field-group input, .field-group select, .field-group textarea{
    padding:12px;border-radius:10px;border:1px solid var(--border);font-family:inherit;font-size:14px;
    background:#fff;transition:0.2s;width:100%
}
.field-group input:focus, .field-group select:focus, .field-group textarea:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 3px rgba(37,99,235,0.1)}

.select-wrapper{display:flex;gap:8px}
.select-wrapper button{padding:0 12px;background:var(--primary-light);color:#fff;border:none;border-radius:8px;cursor:pointer}

/* Botão Anexo */
.btn-add-anexo {
    width: 100%; padding: 12px; border: 2px dashed #cbd5e1; background: #f8fafc; color: var(--text-light);
    border-radius: 12px; font-weight: 500; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-add-anexo:hover { border-color: var(--accent); color: var(--accent); background: #eff6ff; }
.anexo-item { display: flex; align-items: center; gap: 8px; margin-top: 8px; padding: 8px; background: #f1f5f9; border-radius: 8px; font-size: 13px; }
.anexo-item input { border: none; background: transparent; padding: 4px; font-size: 13px; width: 100%; }

.modal-actions{display:flex;justify-content:flex-end;gap:12px;margin-top:32px;padding-top:20px;border-top:1px solid var(--border)}
.btn-cancel{background:#f3f4f6;color:var(--text);padding:12px 24px;border-radius:10px;border:none;font-weight:500;cursor:pointer}
.btn-save{background:var(--ind-green);color:#fff;padding:12px 24px;border-radius:10px;border:none;font-weight:500;cursor:pointer;box-shadow:0 4px 12px rgba(34,197,94,0.3)}

/* VIEW MODAL */
#viewContent { display: flex; flex-direction: column; gap: 24px; }
.view-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
.view-status { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; color: #fff; }
.view-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; background: #f9fafb; padding: 20px; border-radius: 16px; }
.view-item label { display: block; font-size: 11px; text-transform: uppercase; color: #9ca3af; font-weight: 600; margin-bottom: 4px; }
.view-item div { font-size: 15px; color: var(--primary); font-weight: 500; }
.view-desc { background: #fff; padding: 16px; border-radius: 12px; border: 1px solid var(--border); line-height: 1.6; color: #4b5563; }
.view-files h4 { font-size: 14px; margin: 0 0 12px; color: var(--primary); }
.file-chip { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: #fff; border: 1px solid #bfdbfe; color: #1e40af; border-radius: 20px; font-size: 13px; text-decoration: none; font-weight: 500; transition:0.2s; cursor: pointer; }
.file-chip:hover { background: #eff6ff; }

/* List Manager */
.list-manager table { width: 100%; border-collapse: collapse; }
.list-manager td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; }
.list-manager .remove { color: var(--ind-red); cursor: pointer; text-align: right; }
.color-dot { width: 12px; height: 12px; border-radius: 4px; display: inline-block; margin-right: 8px; border: 1px solid rgba(0,0,0,0.1); }

/* Color Picker in Manager */
.color-picker { display: flex; gap: 10px; margin-top: 12px; justify-content: center; }
.color-option { width: 24px; height: 24px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
.color-option:hover { transform: scale(1.1); }
.color-option.selected { border-color: var(--text); transform: scale(1.1); box-shadow: 0 0 0 2px rgba(0,0,0,0.1); }

/* Styles for specific colors */
.bg-blue { background-color: var(--c-blue); }
.bg-green { background-color: var(--c-green); }
.bg-red { background-color: var(--c-red); }
.bg-orange { background-color: var(--c-orange); }
.bg-yellow { background-color: var(--c-yellow); }
.bg-purple { background-color: var(--c-purple); }
.bg-default { background-color: var(--c-default); }

/* --- LOGIN & SECURITY STYLES --- */
#loginOverlay {
    position: fixed; inset: 0; background: rgba(255,255,255,0.4); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    display: flex; justify-content: center; align-items: center; z-index: 9999;
}
.login-box {
    background: #fff; padding: 40px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border);
}
.login-box h2 { margin-top: 0; color: var(--primary); margin-bottom: 10px; }
.login-box p { color: var(--text-light); margin-bottom: 24px; font-size: 14px; }
.login-input {
    width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 12px; font-size: 16px; margin-bottom: 16px;
    text-align: center; transition: 0.2s; outline: none;
}
.login-input:focus { border-color: var(--accent); }
.login-input.error { border-color: var(--c-red); color: var(--c-red); background: #fef2f2; }
.btn-login {
    width: 100%; padding: 14px; background: var(--primary); color: #fff; border: none; border-radius: 12px;
    font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s;
}
.btn-login:hover { background: var(--primary-light); }
.btn-login:disabled { background: var(--text-light); cursor: not-allowed; }

/* Shake Animation */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}
.shake { animation: shake 0.5s; }

#timerDisplay { margin-top: 10px; color: var(--c-red); font-weight: 700; font-size: 14px; min-height: 20px;}
#loadingText { margin-top: 15px; color: var(--accent); font-size: 13px; display: none; }

/* Adicionado: Estilos de Histórico no View Modal */
.view-history {
    background: #fff; 
    padding: 16px; 
    border-radius: 12px; 
    border: 1px solid var(--border);
    margin-top: 20px;
}
.view-history h4 { 
    font-size: 14px; 
    margin: 0 0 12px; 
    color: var(--primary); 
    border-bottom: 1px dashed var(--border);
    padding-bottom: 8px;
}
.history-item {
    padding: 8px 0;
    border-bottom: 1px dotted #e5e7eb;
    font-size: 13px;
    color: var(--text);
}
.history-item:last-child {
    border-bottom: none;
}
.history-item strong {
    color: var(--primary);
    font-weight: 600;
    margin-right: 5px;
}
.history-item small {
    display: block;
    color: var(--text-light);
    margin-top: 2px;
}

/* Paginação do Histórico */
.history-pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    font-size: 13px;
    color: var(--text-light);
}
.history-pagination button {
    background: var(--bg);
    border: 1px solid var(--border);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: 0.2s;
}
.history-pagination button:hover {
    background: #e5e7eb;
    color: var(--primary);
}
.history-pagination button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
    background: var(--bg);
    color: var(--text-light);
}
.btn-toggle-menu {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    margin-right: 15px;
    display: none; /* Inicia oculto, será exibido no Mobile */
}

/* Modificações globais para a transição */
.sidebar, .main-content {
    transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
}

/* 1. LAYOUT MOBILE (Telas <= 1024px) */
@media (max-width: 1024px) {
    /* Exibe o botão Hambúrguer */
    .btn-toggle-menu {
        display: block;
    }

    /* Oculta a barra lateral, move para fora da tela e torna o layout principal full-width */
    .sidebar {
        position: fixed;
        height: 100vh;
        z-index: 1001;
        transform: translateX(-260px); /* Move para fora da tela */
    }
    
    /* Quando a sidebar está visível (aberta) */
    body.sidebar-open .sidebar {
        transform: translateX(0);
    }
    
    /* O conteúdo principal ocupa 100% da largura do viewport */
    .main-content {
        width: 100%;
        margin-left: 0;
    }

    /* Ajuste no padding do header e content para telas pequenas */
    .header {
        padding: 15px 20px;
        height: 70px;
    }
    .content {
        padding: 20px 20px;
    }
    .dashboard-charts {
        grid-template-columns: 1fr; /* Força uma única coluna */
        gap: 20px;
    }
}
</style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box" id="loginBox">
        <i class="fa-solid fa-lock fa-3x" style="color:var(--primary); margin-bottom:16px;"></i>
        <h2>Acesso Restrito</h2>
        <p>Digite a senha mestra para acessar o dashboard.</p>
        
        <input type="password" id="passwordInput" class="login-input" placeholder="Senha" autofocus>
        <button class="btn-login" id="btnLogin" onclick="checkLogin()">Entrar</button>
        
        <div id="timerDisplay"></div>
        <div id="loadingText"><i class="fas fa-spinner fa-spin"></i> Conectando ao servidor...</div>
    </div>
</div>

<aside class="sidebar">
    <div class="sidebar-logo"><i class="fa-solid fa-layer-group"></i> Auditoria LAMIC</div>
    <div class="sidebar-divider"></div>
    <button id="tabDashboard"><i class="fa-solid fa-chart-line"></i> Dashboard</button> 
    <div class="sidebar-divider"></div>
    <button id="tabAuditoria" class="active"><i class="fa-solid fa-clipboard-check"></i> Auditoria</button>
    
    <button id="tabDocumentos"><i class="fa-solid fa-file-alt"></i> Documentos</button> 
    <button id="tabAtividades"><i class="fa-solid fa-list-check"></i> Gestão de Atividades</button>
    <button id="tabManutencao"><i class="fa-solid fa-wrench"></i> Manutenção</button>
    <div class="sidebar-divider"></div>
    <button id="tabBackup"><i class="fa-solid fa-database"></i> Backup</button>
    <div class="sidebar-divider"></div>
</aside>

<div class="main-content">
    <header class="header">
        <button id="menuToggle" class="btn-toggle-menu" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <div class="title-area">
            <h1 id="pageTitle">Dashboard</h1>
            <small id="pageSubtitle">Visão geral e indicadores de desempenho</small>
        </div>
        </header>

    <div class="content">
        
        <div class="filters-bar" id="filtersBarDashboard" style="display:flex;">
            <div class="filter-controls">
                <div style="font-weight:600; color:var(--primary); font-size:14px;"><i class="fa-solid fa-filter"></i> Filtros:</div>
                
                <div id="filtersDashboard" class="filter-group">
                    <select id="fDashArea" class="filter-input" onchange="onFilterDashboardChange()">
                        <option value="">Área: Todas</option>
                        <option value="audit">Auditoria</option>
                        <option value="ativ">Gestão de Atividades</option>
                        <option value="mant">Manutenção</option>
                        <option value="doc">Documentos</option>
                    </select>
                    <select id="fDashSetor" class="filter-input" onchange="onFilterDashboardChange()">
                        <option value="">Setor: Todos</option>
                    </select>
                    <select id="fDashStatus" class="filter-input" onchange="onFilterDashboardChange()">
                        <option value="">Status: Todos</option>
                    </select>
                    
                    <div class="date-controls">
                        <select id="fDashDateType" onchange="updateDateInputs('Dash')">
                            <option value="all" selected>Período: Todas</option>
                            <option value="month">Mês</option>
                            <option value="year">Ano</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        
                        <div id="fDashGroupMonth" style="display:none; gap:4px">
                            <select id="fDashMonth" onchange="onFilterDashboardChange()">
                                <option value="0">Jan</option><option value="1">Fev</option><option value="2">Mar</option>
                                <option value="3">Abr</option><option value="4">Mai</option><option value="5">Jun</option>
                                <option value="6">Jul</option><option value="7">Ago</option><option value="8">Set</option>
                                <option value="9">Out</option><option value="10">Nov</option><option value="11">Dez</option>
                            </select>
                            <select id="fDashYearForMonth" onchange="onFilterDashboardChange()"></select>
                        </div>

                        <select id="fDashYearOnly" style="display:none" onchange="onFilterDashboardChange()"></select>

                        <div id="fDashGroupCustom" style="display:none; align-items:center; gap:4px">
                            <input type="date" id="fDashDataIni" onchange="onFilterDashboardChange()">
                            <span style="color:#ccc">a</span>
                            <input type="date" id="fDashDataFim" onchange="onFilterDashboardChange()">
                        </div>
                    </div>
                </div>

                <button class="btn-clear" onclick="clearDashboardFilters()" title="Limpar filtros"><i class="fa-solid fa-rotate-left"></i></button>
            </div>
            </div>

        <div id="dashboardContent" style="display:flex;">
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="icon-header">
                        <i class="fas fa-chart-pie" style="color:var(--c-blue); background:#eff6ff"></i>
                        <p>Total de Registros</p>
                    </div>
                    <h2 id="summaryTotalCount">0</h2>
                </div>
                <div class="summary-card">
                    <div class="icon-header">
                        <i class="fas fa-calendar-check" style="color:var(--ind-green); background:#f0fdf4"></i>
                        <p>Total Concluído</p>
                    </div>
                    <h2 id="summaryCompletedCount">0</h2>
                </div>
                <div class="summary-card">
                    <div class="icon-header">
                        <i class="fas fa-hourglass-half" style="color:var(--c-yellow); background:#fffbeb"></i>
                        <p>Total Ativo</p>
                    </div>
                    <h2 id="summaryActiveCount">0</h2>
                </div>
                <div class="summary-card">
                    <div class="icon-header">
                        <i class="fas fa-exclamation-triangle" style="color:var(--ind-red); background:#fef2f2"></i>
                        <p>Total Atrasado</p>
                    </div>
                    <h2 id="summaryOverdueCount">0</h2>
                </div>
            </div>

            <div class="dashboard-charts">
                <div class="chart-card">
                    <h3><i class="fas fa-thumbtack"></i> Status Consolidado de Itens Ativos</h3>
                    <div class="chart-content">
                        <ul class="chart-list" id="chartStatusConsolidado">
                            </ul>
                    </div>
                </div>
                <div class="chart-card">
                    <h3><i class="fas fa-industry"></i> Distribuição por Setor</h3>
                    <div class="chart-content">
                        <ul class="chart-list" id="chartDistribuicaoSetor">
                            </ul>
                    </div>
                </div>
            </div>

            <div class="dashboard-charts" style="grid-template-columns: 1fr;">
                <div class="chart-card">
                    <h3><i class="fas fa-clock"></i> Alerta de Prazos (Itens Ativos)</h3>
                    <div class="chart-content">
                        <ul class="chart-list" id="chartAlertaPrazos">
                            </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="backupContent" style="display:none;">
            <div class="backup-card">
                <i class="fa-solid fa-cloud-arrow-down fa-3x" style="color:var(--primary); margin-bottom:16px;"></i>
                <h2 style="margin:0 0 8px; color:var(--primary)">Central de Backup</h2>
                <p style="color:var(--text-light); margin:0 0 24px 0">Gerencie seus dados via Nuvem (JSONBin) ou Arquivo Local.</p>
                
                <div class="backup-actions" style="flex-wrap: wrap;">
                    <button class="btn-large btn-export" onclick="exportLocalData()" style="background:var(--ind-green); color:#fff; border:none; flex:1;">
                        <i class="fas fa-download"></i> Baixar Dados
                    </button>
                    <button class="btn-large btn-import" onclick="document.getElementById('fileInput').click()" style="background:#fff; color:var(--text); border:2px solid var(--border); flex:1;">
                        <i class="fas fa-upload"></i> Importar Dados
                    </button>
                    <input type="file" id="fileInput" style="display:none" onchange="importLocalData(this)" accept=".json">
                </div>
                <p style="font-size:12px; color:#999; margin-top:20px">Nota: Ao restaurar um arquivo local, ele será automaticamente sincronizado com a nuvem.</p>
            </div>
        </div>

        <div class="filters-bar" id="filtersBar" style="display:none;">
            <div class="filter-controls">
                <div style="font-weight:600; color:var(--primary); font-size:14px;"><i class="fa-solid fa-filter"></i> Filtros:</div>
                
                <div id="filtersAuditoria" class="filter-group" style="display:flex;">
                    <select id="fAuditSetor" class="filter-input" onchange="onFilterSetorChange('Audit')">
                        <option value="">Setor: Todos</option>
                    </select>
                    <select id="fAuditCat" class="filter-input" onchange="onFilterCategoryChange('Audit')">
                        <option value="">Categoria: Todas</option>
                    </select>
                    <select id="fAuditSub" class="filter-input" onchange="renderCards()">
                        <option value="">Subcategoria: Todas</option>
                    </select>
                    <select id="fAuditStatus" class="filter-input" onchange="renderCards()">
                        <option value="">Status: Todos</option>
                    </select>
                    
                    <div class="date-controls">
                        <select id="fAuditDateType" onchange="updateDateInputs('Audit')">
                            <option value="all" selected>Período: Data</option>
                            <option value="month">Mês</option>
                            <option value="year">Ano</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        
                        <div id="fAuditGroupMonth" style="display:none; gap:4px">
                            <select id="fAuditMonth" onchange="renderCards()">
                                <option value="0">Jan</option><option value="1">Fev</option><option value="2">Mar</option>
                                <option value="3">Abr</option><option value="4">Mai</option><option value="5">Jun</option>
                                <option value="6">Jul</option><option value="7">Ago</option><option value="8">Set</option>
                                <option value="9">Out</option><option value="10">Nov</option><option value="11">Dez</option>
                            </select>
                            <select id="fAuditYearForMonth" onchange="renderCards()"></select>
                        </div>

                        <select id="fAuditYearOnly" style="display:none" onchange="renderCards()"></select>

                        <div id="fAuditGroupCustom" style="display:none; align-items:center; gap:4px">
                            <input type="date" id="fAuditDataIni" onchange="renderCards()">
                            <span style="color:#ccc">a</span>
                            <input type="date" id="fAuditDataFim" onchange="renderCards()">
                        </div>
                    </div>
                </div>

                <div id="filtersAtividades" class="filter-group" style="display:none;">
                    <select id="fAtivSetor" class="filter-input" onchange="onFilterSetorChange('Ativ')">
                        <option value="">Setor: Todos</option>
                    </select>
                    <select id="fAtivCat" class="filter-input" onchange="onFilterCategoryChange('Ativ')">
                        <option value="">Categoria: Todas</option>
                    </select>
                    <select id="fAtivSub" class="filter-input" onchange="renderCards()">
                        <option value="">Subcategoria: Todas</option>
                    </select>
                    <select id="fAtivStatus" class="filter-input" onchange="renderCards()">
                        <option value="">Status: Todos</option>
                    </select>
                    
                    <div class="date-controls">
                        <select id="fAtivDateType" onchange="updateDateInputs('Ativ')">
                            <option value="all" selected>Período: Data</option>
                            <option value="month">Mês</option>
                            <option value="year">Ano</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        
                        <div id="fAtivGroupMonth" style="display:none; gap:4px">
                            <select id="fAtivMonth" onchange="renderCards()">
                                <option value="0">Jan</option><option value="1">Fev</option><option value="2">Mar</option>
                                <option value="3">Abr</option><option value="4">Mai</option><option value="5">Jun</option>
                                <option value="6">Jul</option><option value="7">Ago</option><option value="8">Set</option>
                                <option value="9">Out</option><option value="10">Nov</option><option value="11">Dez</option>
                            </select>
                            <select id="fAtivYearForMonth" onchange="renderCards()"></select>
                        </div>

                        <select id="fAtivYearOnly" style="display:none" onchange="renderCards()"></select>

                        <div id="fAtivGroupCustom" style="display:none; align-items:center; gap:4px">
                            <input type="date" id="fAtivDataIni" onchange="renderCards()">
                            <span style="color:#ccc">a</span>
                            <input type="date" id="fAtivDataFim" onchange="renderCards()">
                        </div>
                    </div>
                </div>

                <div id="filtersManutencao" class="filter-group" style="display:none;">
                    <select id="fMantSetor" class="filter-input" onchange="onFilterSetorChange('Mant')">
                        <option value="">Setor: Todos</option>
                    </select>
                    <select id="fMantCat" class="filter-input" onchange="onFilterCategoryChange('Mant')">
                        <option value="">Categoria: Todas</option>
                    </select>
                    <select id="fMantItem" class="filter-input" onchange="renderCards()">
                        <option value="">Item: Todos</option>
                    </select>
                    <select id="fMantStatus" class="filter-input" onchange="renderCards()">
                        <option value="">Status: Todos</option>
                    </select>
                    
                    <div class="date-controls">
                        <select id="fMantDateType" onchange="updateDateInputs('Mant')">
                            <option value="all" selected>Próxima: Data</option>
                            <option value="month">Mês</option>
                            <option value="year">Ano</option>
                            <option value="custom">Personalizado</option>
                        </select>

                        <div id="fMantGroupMonth" style="display:none; gap:4px">
                            <select id="fMantMonth" onchange="renderCards()">
                                <option value="0">Jan</option><option value="1">Fev</option><option value="2">Mar</option>
                                <option value="3">Abr</option><option value="4">Mai</option><option value="5">Jun</option>
                                <option value="6">Jul</option><option value="7">Ago</option><option value="8">Set</option>
                                <option value="9">Out</option><option value="10">Nov</option><option value="11">Dez</option>
                            </select>
                            <select id="fMantYearForMonth" onchange="renderCards()"></select>
                        </div>

                        <select id="fMantYearOnly" style="display:none" onchange="renderCards()"></select>

                        <div id="fMantGroupCustom" style="display:none; align-items:center; gap:4px">
                            <input type="date" id="fMantDataIni" onchange="renderCards()">
                            <span style="color:#ccc">a</span>
                            <input type="date" id="fMantDataFim" onchange="renderCards()">
                        </div>
                    </div>
                </div>

                <div id="filtersDocumentos" class="filter-group" style="display:none;"> 
                    <select id="fDocSetor" class="filter-input" onchange="onFilterSetorChange('Doc')">
                        <option value="">Setor: Todos</option>
                    </select>
                    <select id="fDocCat" class="filter-input" onchange="onFilterCategoryChange('Doc')">
                        <option value="">Categoria: Todas</option>
                    </select>
                    <select id="fDocSub" class="filter-input" onchange="renderCards()">
                        <option value="">Subcategoria: Todas</option>
                    </select>
                    <select id="fDocStatus" class="filter-input" onchange="renderCards()">
                        <option value="">Status: Todos</option>
                    </select>
                    
                    <div class="date-controls">
                        <select id="fDocDateType" onchange="updateDateInputs('Doc')">
                            <option value="all" selected>Data: Todas</option>
                            <option value="month">Mês</option>
                            <option value="year">Ano</option>
                            <option value="custom">Personalizado</option>
                        </select>

                        <div id="fDocGroupMonth" style="display:none; gap:4px">
                            <select id="fDocMonth" onchange="renderCards()">
                                <option value="0">Jan</option><option value="1">Fev</option><option value="2">Mar</option>
                                <option value="3">Abr</option><option value="4">Mai</option><option value="5">Jun</option>
                                <option value="6">Jul</option><option value="7">Ago</option><option value="8">Set</option>
                                <option value="9">Out</option><option value="10">Nov</option><option value="11">Dez</option>
                            </select>
                            <select id="fDocYearForMonth" onchange="renderCards()"></select>
                        </div>

                        <select id="fDocYearOnly" style="display:none" onchange="renderCards()"></select>

                        <div id="fDocGroupCustom" style="display:none; align-items:center; gap:4px">
                            <input type="date" id="fDocDataIni" onchange="renderCards()">
                            <span style="color:#ccc">a</span>
                            <input type="date" id="fDocDataFim" onchange="renderCards()">
                        </div>
                    </div>
                </div>

                <button class="btn-clear" onclick="clearFilters()" title="Limpar filtros"><i class="fa-solid fa-rotate-left"></i></button>
            </div>
            
            <button class="btn-primary" id="addBtn"> <i class="fas fa-plus"></i> Novo Registro
            </button>
        </div>

        <div class="cards-grid" id="cardsGrid" style="display:none;">
            </div>
    </div>
</div>

<div class="modal" id="modalAuditoria">
    <div class="modal-content">
        <div class="modal-header"><h3>Nova Auditoria</h3></div>
        <div class="form-grid">
            <div class="field-group full-width">
                <label>Título</label>
                <input id="auditTitulo" placeholder="Ex: Auditoria Interna ISO 9001">
            </div>
            <div class="field-group full-width">
                <label>Descrição</label>
                <textarea id="auditDescricao" rows="2"></textarea>
            </div>
            <div class="field-group">
                <label>Setor</label>
                <div class="select-wrapper">
                    <select id="auditSetor" onchange="onCategoryChange('audit')"></select>
                    <button onclick="openListManager('setores')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Categoria</label>
                <div class="select-wrapper">
                    <select id="auditCategoria" onchange="onCategoryChange('audit')"></select>
                    <button onclick="openListManager('categorias')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Subcategoria</label>
                <div class="select-wrapper">
                    <select id="auditSub"></select>
                    <button onclick="openListManager('subcategorias')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Status</label>
                <div class="select-wrapper">
                    <select id="auditStatus"></select>
                    <button onclick="openListManager('status')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Data Publicação</label>
                <input type="date" id="auditDataPublicacao">
            </div>
            <div class="field-group">
                <label>Data Previsão</label>
                <input type="date" id="auditDataPrevisao">
            </div>
            <div class="field-group">
                <label>Responsável</label> <input id="auditResponsavel" placeholder="Nome do Responsável">
            </div>
            <div class="field-group">
                <label>Alerta (Dias antes)</label>
                <input type="number" id="auditFlagDias" value="7">
            </div>
            <div class="field-group full-width">
                <label>Anexos</label>
                <div id="auditAnexos"></div>
                <button type="button" class="btn-add-anexo" onclick="addAnexo('audit')">
                    <i class="fas fa-paperclip"></i> Adicionar Arquivo ou Link
                </button>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('modalAuditoria')">Cancelar</button>
            <button class="btn-save" onclick="saveAudit()">Salvar Registro</button>
        </div>
    </div>
</div>

<div class="modal" id="modalAtividades">
    <div class="modal-content">
        <div class="modal-header"><h3>Nova Atividade</h3></div>
        <div class="form-grid">
            <div class="field-group full-width">
                <label>Título</label>
                <input id="ativTitulo" placeholder="Ex: Treinamento de Segurança">
            </div>
            <div class="field-group full-width">
                <label>Descrição</label>
                <textarea id="ativDescricao" rows="2"></textarea>
            </div>
            <div class="field-group">
                <label>Setor</label>
                <div class="select-wrapper">
                    <select id="ativSetor" onchange="onCategoryChange('ativ')"></select>
                    <button onclick="openListManager('setores')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Categoria</label>
                <div class="select-wrapper">
                    <select id="ativCategoria" onchange="onCategoryChange('ativ')"></select>
                    <button onclick="openListManager('categorias')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Subcategoria</label>
                <div class="select-wrapper">
                    <select id="ativSub"></select>
                    <button onclick="openListManager('subcategorias')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Status</label>
                <div class="select-wrapper">
                    <select id="ativStatus"></select>
                    <button onclick="openListManager('status')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Data Início</label>
                <input type="date" id="ativDataInicio">
            </div>
            <div class="field-group">
                <label>Data Conclusão</label>
                <input type="date" id="ativDataConclusao">
            </div>
            <div class="field-group">
                <label>Responsável</label> <input id="ativResponsavel" placeholder="Nome do Responsável">
            </div>
            <div class="field-group">
                <label>Alerta (Dias antes)</label>
                <input type="number" id="ativFlagDias" value="3">
            </div>
            <div class="field-group full-width">
                <label>Anexos</label>
                <div id="ativAnexos"></div>
                <button type="button" class="btn-add-anexo" onclick="addAnexo('ativ')">
                    <i class="fas fa-paperclip"></i> Adicionar Arquivo ou Link
                </button>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('modalAtividades')">Cancelar</button>
            <button class="btn-save" onclick="saveAtividade()">Salvar Registro</button>
        </div>
    </div>
</div>

<div class="modal" id="modalManutencao">
    <div class="modal-content">
        <div class="modal-header"><h3>Nova Manutenção</h3></div>
        <div class="form-grid">
            <div class="field-group full-width">
                <label>Título</label>
                <input id="mantTitulo" placeholder="Ex: Troca de filtros">
            </div>
            <div class="field-group full-width">
                <label>Descrição</label>
                <textarea id="mantDescricao" rows="2"></textarea>
            </div>
            <div class="field-group">
                <label>Setor</label>
                <div class="select-wrapper">
                    <select id="mantSetor" onchange="onCategoryChange('mant')"></select>
                    <button onclick="openListManager('setores')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Categoria</label>
                <div class="select-wrapper">
                    <select id="mantCategoria" onchange="onCategoryChange('mant')"></select>
                    <button onclick="openListManager('categorias')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Item / Equipamento</label>
                <div class="select-wrapper">
                    <select id="mantItem"></select>
                    <button onclick="openListManager('itens')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Última Manutenção</label>
                <input type="date" id="mantUltima" onchange="calculateNextDate('mant')">
            </div>
            <div class="field-group">
                <label>Periodicidade (Dias)</label>
                <input type="number" id="mantIntervalo" value="30" onchange="calculateNextDate('mant')">
            </div>
            <div class="field-group">
                <label>Responsável Técnico</label> <input id="mantResponsavelTecnico" placeholder="Nome do Técnico">
            </div>
            <div class="field-group">
                <label>Responsável pela Manutenção</label> <input id="mantResponsavelManutencao" placeholder="Nome do Gestor">
            </div>
            <div class="field-group full-width" style="background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd">
                <label style="color:#0369a1">Próxima Manutenção (Calculada)</label>
                <div id="mantProxima" style="font-size:16px; font-weight:700; color:#0c4a6e; margin-top:4px">--/--/----</div>
            </div>
            <div class="field-group">
                <label>Status</label>
                <div class="select-wrapper">
                    <select id="mantStatus"></select>
                    <button onclick="openListManager('status')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Alerta (Dias)</label>
                <input type="number" id="mantFlagDias" value="7">
            </div>
            <div class="field-group full-width">
                <label>Anexos</label>
                <div id="mantAnexos"></div>
                <button type="button" class="btn-add-anexo" onclick="addAnexo('mant')">
                    <i class="fas fa-paperclip"></i> Adicionar Arquivo ou Link
                </button>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('modalManutencao')">Cancelar</button>
            <button class="btn-save" onclick="saveManutencao()">Salvar Registro</button>
        </div>
    </div>
</div>

<div class="modal" id="modalDocumentos"> <div class="modal-content">
        <div class="modal-header"><h3>Novo Documento</h3></div>
        <div class="form-grid">
            <div class="field-group full-width">
                <label>Título/Nome do Documento</label>
                <input id="docTitulo" placeholder="Ex: Procedimento Operacional Padrão 01">
            </div>
            <div class="field-group full-width">
                <label>Descrição/Resumo</label>
                <textarea id="docDescricao" rows="2"></textarea>
            </div>
            <div class="field-group">
                <label>Setor</label>
                <div class="select-wrapper">
                    <select id="docSetor" onchange="onCategoryChange('doc')"></select>
                    <button onclick="openListManager('setores')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Categoria</label>
                <div class="select-wrapper">
                    <select id="docCategoria" onchange="onCategoryChange('doc')"></select>
                    <button onclick="openListManager('categorias')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Subcategoria</label>
                <div class="select-wrapper">
                    <select id="docSub"></select>
                    <button onclick="openListManager('subcategorias')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Status</label>
                <div class="select-wrapper">
                    <select id="docStatus"></select>
                    <button onclick="openListManager('status')"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="field-group">
                <label>Data de Criação</label>
                <input type="date" id="docDataCriacao" onchange="calculateNextDate('doc')">
            </div>
            <div class="field-group">
                <label>Periodicidade (Dias)</label>
                <input type="number" id="docIntervalo" value="365" onchange="calculateNextDate('doc')">
            </div>
            <div class="field-group full-width" style="background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd">
                <label style="color:#0369a1">Próxima Revisão (Calculada)</label>
                <div id="docProximaRevisao" style="font-size:16px; font-weight:700; color:#0c4a6e; margin-top:4px">--/--/----</div>
            </div>
            <div class="field-group">
                <label>Responsável</label>
                <input id="docResponsavel" placeholder="Responsável pela elaboração">
            </div>
            <div class="field-group">
                <label>Revisor/Aprovador</label>
                <input id="docRevisor" placeholder="Revisor ou Aprovador">
            </div>
            <div class="field-group">
                <label>Alerta (Dias antes da revisão)</label>
                <input type="number" id="docFlagDias" value="30">
            </div>
            <div class="field-group full-width">
                <label>Anexos (Link para o documento)</label>
                <div id="docAnexos"></div>
                <button type="button" class="btn-add-anexo" onclick="addAnexo('doc')">
                    <i class="fas fa-paperclip"></i> Adicionar Link
                </button>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('modalDocumentos')">Cancelar</button>
            <button class="btn-save" onclick="saveDocumento()">Salvar Registro</button>
        </div>
    </div>
</div>

<div class="modal" id="viewModal">
    <div class="modal-content">
        <div id="viewContent"></div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('viewModal')">Fechar</button>
        </div>
    </div>
</div>

<div class="modal" id="modalListManager">
    <div class="modal-content" style="width:400px">
        <h3 id="listTitle" style="margin-bottom:16px">Gerenciar</h3>
        
        <div class="field-group">
            <input id="newListItem" placeholder="Nome..." style="width:100%">
        </div>
        
        <div id="colorPickerContainer" style="display:none; text-align:center; padding:10px 0;">
            <label style="display:block; font-size:11px; margin-bottom:8px; color:#6b7280; font-weight:600">Selecione a Cor</label>
            <div class="color-picker">
                <div class="color-option bg-blue" onclick="selectColor('blue', this)"></div>
                <div class="color-option bg-green" onclick="selectColor('green', this)"></div>
                <div class="color-option bg-red" onclick="selectColor('red', this)"></div>
                <div class="color-option bg-orange" onclick="selectColor('orange', this)"></div>
                <div class="color-option bg-yellow" onclick="selectColor('yellow', this)"></div>
                <div class="color-option bg-purple" onclick="selectColor('purple', this)"></div>
                <div class="color-option bg-default selected" onclick="selectColor('default', this)"></div>
            </div>
        </div>

        <button onclick="addToList()" class="btn-primary" style="width:100%; margin-top:12px; justify-content:center">Adicionar</button>

        <div class="list-manager" style="margin-top:16px; max-height:300px; overflow-y:auto">
            <table>
                <tbody id="listBody"></tbody>
            </table>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('modalListManager')">Concluir</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURAÇÃO JSONBIN E SEGURANÇA ---
    const API_KEY = '$2a$10$2elKW8TT6o.K3V176efqwu7kOfD1PnS3D/F0s4Tczc3MYmaU.N1bi';
    const DATA_BIN_ID = '693d73c4ae596e708f976cf4';
    const PASSWORD_BIN_ID = '68d7e57bd0ea881f408cf33b';
    
    let failedAttempts = 0;
    let lockoutTimer = null;
    
    // --- DADOS E ESTADO (Iniciam vazios) ---
    let audits = [];
    let activities = [];
    let maintenances = [];
    let documents = []; 
    
    // NOVO: Armazena o item original no momento da abertura do modal de edição
    let originalItem = null; 

    // --- CORREÇÃO: ZERANDO ESTRUTURAS PRÉ-CADASTRADAS DE STATUS ---
    const defaultMasterLists = {
        // Listas Principais (Limpas)
        setores: [], 
        auditCategorias: [],
        ativCategorias: [],
        mantCategorias: [],
        docCategorias: [], 
    
        // Listas de Subcategorias/Itens (Limpas)
        auditSubcats: {},
        ativSubcats: {},
        mantItens: {},
        docSubcats: {},
    
        // Listas de Status: ZERADAS (Serão preenchidas via interface/API)
        // Se estiverem vazias, o usuário deve criá-las via modal.
        auditStatus: [], 
        ativStatus: [], 
        mantStatus: [], 
        docStatus: [], 
    
        // O unifiedStatusMap também será removido ou gerado dinamicamente para usar apenas os nomes das listas acima.
    };
    
    let masterLists = JSON.parse(JSON.stringify(defaultMasterLists)); // Clone inicial
    
    let currentTab = 'dashboard'; 
    let editingAuditId = null;
    let editingAtivId = null;
    let editingMantId = null;
    let editingDocId = null; 
    let currentListKey = null; 
    let selectedColorTemp = 'default';
    let currentHistoryPage = 1; // NOVO: Para controle da paginação do histórico
    
    // --- UTILITÁRIOS ---
    const today = () => new Date().toISOString().split('T')[0];
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth();
    const formatBR = dateStr => {
        if (!dateStr) return 'ND';
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
    };
    const daysDiff = dateStr => Math.ceil((new Date(dateStr) - new Date()) / (1000*60*60*24));
    
    const colorMap = {
        'blue': 'var(--c-blue)',
        'green': 'var(--c-green)',
        'red': 'var(--c-red)',
        'orange': 'var(--c-orange)',
        'yellow': 'var(--c-yellow)',
        'purple': 'var(--c-purple)',
        'default': 'var(--c-default)'
    };

    // NOVO: Dicionário para mapear chaves de objeto para nomes de exibição
    const fieldNames = {
        // Auditoria
        auditTitulo: 'Título', auditDescricao: 'Descrição', auditSetor: 'Setor', auditCategoria: 'Categoria',
        auditSub: 'Subcategoria', auditStatus: 'Status', auditDataPublicacao: 'Data Publicação',
        auditDataPrevisao: 'Data Previsão', auditResponsavel: 'Responsável', auditFlagDias: 'Alerta (Dias)',
        
        // Atividades
        ativTitulo: 'Título', ativDescricao: 'Descrição', ativSetor: 'Setor', ativCategoria: 'Categoria',
        ativSub: 'Subcategoria', ativStatus: 'Status', ativDataInicio: 'Data Início',
        ativDataConclusao: 'Data Conclusão', ativResponsavel: 'Responsável', ativFlagDias: 'Alerta (Dias)',
        
        // Manutenção
        mantTitulo: 'Título', mantDescricao: 'Descrição', mantSetor: 'Setor', mantCategoria: 'Categoria',
        mantItem: 'Item/Equipamento', mantUltima: 'Última Manutenção', mantIntervalo: 'Periodicidade (Dias)',
        mantResponsavelTecnico: 'Responsável Técnico', mantResponsavelManutencao: 'Responsável Manutenção',
        mantStatus: 'Status', mantFlagDias: 'Alerta (Dias)', mantProxima: 'Próxima Manutenção',
        
        // Documentos
        docTitulo: 'Título', docDescricao: 'Descrição', docSetor: 'Setor', docCategoria: 'Categoria',
        docSub: 'Subcategoria', docStatus: 'Status', docDataCriacao: 'Data Criação',
        docIntervalo: 'Periodicidade (Dias)', docResponsavel: 'Responsável', docRevisor: 'Revisor',
        docFlagDias: 'Alerta (Dias)', docProximaRevisao: 'Próxima Revisão',

        // Anexos (Não é uma propriedade direta, mas ajuda a exibir a mudança)
        anexos: 'Anexos'
    };

    // NOVO: Função para calcular e formatar as mudanças
    function calculateChanges(original, current) {
        const changes = [];
        
        // Determina o prefixo do item (audit, ativ, mant, doc)
        const prefix = current.type;
        
        // Propriedades que são derivadas (e não devem ser comparadas)
        const derivedKeys = ['id', 'historico', 'type', 'proxima', 'dataProximaRevisao'];
        
        for (const key in original) {
            // Ignora propriedades derivadas e metadata interna
            if (derivedKeys.includes(key)) continue; 
            if (key === 'anexos') continue; // Anexos são tratados separadamente

            let originalValue = String(original[key] || '').trim();
            let currentValue = String(current[key] || '').trim();

            // Tenta obter o nome de exibição do dicionário fieldNames
            const displayNameKey = `${prefix}${key.charAt(0).toUpperCase() + key.slice(1)}`;
            const displayName = fieldNames[displayNameKey] || key;
            
            // Tratamento especial para números (periodicidade e alerta)
            if (key === 'intervalo' || key === 'docIntervalo' || key === 'flagDias') {
                 // Converte para Number antes de comparar
                 if (Number(original[key]) !== Number(current[key])) {
                    changes.push(`${displayName}: <strong>${originalValue || '0'}</strong> &rarr; <strong>${currentValue || '0'}</strong>`);
                }
                continue;
            }
            
            // Tratamento para datas (somente para exibição no histórico)
            if (key.includes('data') && originalValue) originalValue = formatBR(originalValue);
            if (key.includes('data') && currentValue) currentValue = formatBR(currentValue);

            // Comparação de string para todos os outros campos
            if (originalValue !== currentValue) {
                changes.push(`${displayName}: <strong>${originalValue || 'vazio'}</strong> &rarr; <strong>${currentValue || 'vazio'}</strong>`);
            }
        }

        // Verifica mudanças nos anexos (simplificado)
        const originalAnexosCount = (original.anexos || []).length;
        const currentAnexosCount = (current.anexos || []).length;
        if (originalAnexosCount !== currentAnexosCount) {
             changes.push(`Anexos: Número de anexos alterado (de ${originalAnexosCount} para ${currentAnexosCount})`);
        }
        
        return changes;
    }
    // --- LÓGICA DE LOGIN ---
    document.getElementById('passwordInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') checkLogin();
    });
    
    async function checkLogin() {
        const input = document.getElementById('passwordInput');
        const btn = document.getElementById('btnLogin');
        const loading = document.getElementById('loadingText');
        const loginBox = document.getElementById('loginBox');
        const timerDisplay = document.getElementById('timerDisplay');
        
        if(btn.disabled) return;
    
        const userPass = input.value;
        if(!userPass) return;
    
        btn.disabled = true;
        input.disabled = true;
        loading.style.display = 'block';
    
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${PASSWORD_BIN_ID}/latest`, {
                headers: { 'X-Master-Key': API_KEY }
            });
            
            if(!res.ok) throw new Error('Erro ao verificar senha');
            
            const data = await res.json();
            const remotePass = data.record.password || data.record;
    
            if (String(userPass) === String(remotePass)) {
                loading.innerHTML = '<i class="fas fa-check"></i> Senha correta. Carregando dados...';
                await loadCloudData();
                document.getElementById('loginOverlay').style.display = 'none';
            } else {
                handleLoginError(input, btn, loginBox);
            }
    
        } catch (err) {
            alert("Erro de conexão: " + err.message);
            btn.disabled = false;
            input.disabled = false;
            input.focus();
        } finally {
            loading.style.display = 'none';
        }
    }
    
    function handleLoginError(input, btn, box) {
        failedAttempts++;
        input.classList.add('error');
        box.classList.add('shake');
        
        setTimeout(() => {
            box.classList.remove('shake');
            input.classList.remove('error');
        }, 500);
    
        if (failedAttempts >= 5) {
            let seconds = 10;
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.textContent = `Muitas tentativas. Aguarde ${seconds}s`;
            
            const interval = setInterval(() => {
                seconds--;
                timerDisplay.textContent = `Muitas tentativas. Aguarde ${seconds}s`;
                if (seconds <= 0) {
                    clearInterval(interval);
                    timerDisplay.textContent = "";
                    failedAttempts = 0;
                    input.disabled = false;
                    btn.disabled = false;
                    input.value = "";
                    input.focus();
                }
            }, 1000);
        } else {
            input.disabled = false;
            btn.disabled = false;
            input.value = "";
            input.focus();
        }
    }
    
    // --- INTEGRAÇÃO JSONBIN (DATA) ---
    
    async function loadCloudData() {
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${DATA_BIN_ID}/latest`, {
                headers: { 'X-Master-Key': API_KEY }
            });
            if(!res.ok) throw new Error('Erro ao baixar dados');
            
            const data = await res.json();
            const record = data.record;
    
            audits = record.audits || [];
            activities = record.activities || [];
            maintenances = record.maintenances || [];
            documents = record.documents || []; 
            
            if (record.masterLists) {
                masterLists = { ...defaultMasterLists, ...record.masterLists };
                
                if (Array.isArray(masterLists.mantItens)) {
                    masterLists.mantItens = defaultMasterLists.mantItens; 
                }
            }
            
            // Garante que o histórico exista
            audits.forEach(a => a.historico = a.historico || []);
            activities.forEach(a => a.historico = a.historico || []);
            maintenances.forEach(m => m.historico = m.historico || []);
            documents.forEach(d => d.historico = d.historico || []);
    
            populateYearSelects();
            populateSelects();
            updateDateInputs('Audit');
            updateDateInputs('Ativ');
            updateDateInputs('Mant');
            updateDateInputs('Doc'); 
            updateDateInputs('Dash'); 
            
            switchTab('dashboard'); 
    
        } catch (err) {
            alert("Falha ao carregar dados do Cloud: " + err.message);
        }
    }
    
    async function saveAll(showAlert = false) {
        
        // NOVO: Truncagem do histórico para no máximo 25 itens (5 páginas * 5 itens)
        const maxHistoryItems = 25;
        [audits, activities, maintenances, documents].forEach(arr => {
            arr.forEach(item => {
                if (item.historico && item.historico.length > maxHistoryItems) {
                    item.historico.splice(0, item.historico.length - maxHistoryItems);
                }
            });
        });

        const payload = {
            audits,
            activities,
            maintenances,
            documents, 
            masterLists,
            lastUpdate: new Date().toISOString()
        };
    
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${DATA_BIN_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': API_KEY
                },
                body: JSON.stringify(payload)
            });
    
            if(!res.ok) throw new Error('Erro na API');
            if(showAlert) alert("Dados sincronizados com sucesso!");
            
            if(currentTab === 'dashboard') renderDashboard();
            
        } catch (err) {
            console.error("Erro ao salvar:", err);
            if(showAlert) alert("Erro ao salvar dados: " + err.message);
        }
    }
    
    // --- LÓGICA DO DASHBOARD (CORRIGIDA) ---
    
    // NOVO: Função para obter o statusType dinamicamente
    function getStatusType(statusName) {
        const finalizadoKeywords = ['concluído', 'finalizado', 'publicado'];
        const inativoKeywords = ['cancelado', 'obsoleto'];
        const nameLower = statusName.toLowerCase();
        
        if (finalizadoKeywords.includes(nameLower)) return 'finalizado';
        if (inativoKeywords.includes(nameLower)) return 'inativo';
        
        // Qualquer outro status é considerado ativo para fins de G1 e G3
        return 'ativo';
    }
    
    // NOVO: Função para obter a cor de um status específico (agora a cor é pega da lista mestra dinâmica)
    function getStatusColor(statusName, category) {
        let list;
        if (category === 'audit') list = masterLists.auditStatus;
        else if (category === 'ativ') list = masterLists.ativStatus;
        else if (category === 'mant') list = masterLists.mantStatus;
        else if (category === 'doc') list = masterLists.docStatus;
        
        const statusObj = (list || []).find(s => s.name === statusName);
        return statusObj ? statusObj.color : 'default';
    }
    
    
    function calculateDashboardData() {
        
        // --- OBTENÇÃO DOS VALORES DE FILTRO ---
        const fArea = document.getElementById('fDashArea').value; 
        const fSetor = document.getElementById('fDashSetor').value;
        const fStatus = document.getElementById('fDashStatus').value;
        const fDateType = document.getElementById('fDashDateType').value;
        const fMonth = parseInt(document.getElementById('fDashMonth').value);
        const fYear = parseInt(document.getElementById('fDashYearForMonth').value || document.getElementById('fDashYearOnly').value);
        const fDataIni = document.getElementById('fDashDataIni').value;
        const fDataFim = document.getElementById('fDashDataFim').value;
    
    
        // Constrói uma lista completa de todos os itens com metadados unificados
        const rawItems = [].concat(
            audits.map(a => ({ ...a, type: 'audit', statusType: getStatusType(a.status), dateField: a.dataPublicacao, deadlineField: a.dataPrevisao, color: getStatusColor(a.status, 'audit') })),
            activities.map(a => ({ ...a, type: 'ativ', statusType: getStatusType(a.status), dateField: a.dataInicio, deadlineField: a.dataConclusao, color: getStatusColor(a.status, 'ativ') })),
            maintenances.map(m => ({ ...m, type: 'mant', statusType: getStatusType(m.status), dateField: m.ultima, deadlineField: m.proxima, color: getStatusColor(m.status, 'mant') })),
            documents.map(d => ({ ...d, type: 'doc', statusType: getStatusType(d.status), dateField: d.dataCriacao, deadlineField: d.dataProximaRevisao, color: getStatusColor(d.status, 'doc') }))
        );
        
        // --- FILTRAGEM ---
        let filteredItems = rawItems.filter(item => {
            
            // 1. Filtro por Área/Aba
            if (fArea && item.type !== fArea) return false;
    
            // 2. Filtro por Setor
            const itemSetor = item.setor || 'Setor Não Definido';
            if (fSetor && itemSetor !== fSetor) return false;
    
            // 3. Filtro por Status Consolidado
            if (fStatus && item.status !== fStatus) return false;
    
            // 4. Filtro por Período de Publicação/Criação (dateField)
            if (fDateType !== 'all') {
                const date = item.dateField;
                if (!date) return false;
                
                const itemDate = new Date(date);
    
                if (fDateType === 'month') {
                    if (itemDate.getMonth() !== fMonth || itemDate.getFullYear() !== fYear) return false;
                } else if (fDateType === 'year') {
                    if (itemDate.getFullYear() !== fYear) return false;
                } else if (fDateType === 'custom') {
                    if (fDataIni && date < fDataIni) return false;
                    if (fDataFim && date > fDataFim) return false;
                }
            }
            return true;
        });
    
        // --- CÁLCULOS E AGRUPAMENTOS ---
        const totalCount = filteredItems.length;
        
        const activeItems = filteredItems.filter(item => item.statusType === 'ativo');
        const activeCount = activeItems.length;
    
        const completedCount = filteredItems.filter(item => item.statusType === 'finalizado').length;
        
        const overdueCount = activeItems.filter(item => {
            const d = daysDiff(item.deadlineField);
            return d < 0;
        }).length;
    
        // G1: Status Consolidado
        const statusCounts = {};
        activeItems.forEach(item => {
            const key = `${item.status} (${item.type.toUpperCase()})`;
            statusCounts[key] = {
                count: (statusCounts[key]?.count || 0) + 1,
                color: item.color,
                type: item.type.toUpperCase()
            };
        });
    
        // G2: Distribuição por Setor
        const setorCounts = {};
        activeItems.forEach(item => {
            const setor = item.setor || 'Setor Não Definido';
            setorCounts[setor] = (setorCounts[setor] || 0) + 1;
        });
    
        // G3: Alerta de Prazos
        const prazoCounts = {
            atrasados: { count: 0, color: 'var(--ind-red)', percent: 0 },
            criticos: { count: 0, color: 'var(--ind-yellow)', percent: 0 },
            curtoPrazo: { count: 0, color: 'var(--c-orange)', percent: 0 },
            medioPrazo: { count: 0, color: 'var(--c-blue)', percent: 0 },
            longoPrazo: { count: 0, color: 'var(--ind-green)', percent: 0 }
        };
    
        activeItems.forEach(item => {
            const d = daysDiff(item.deadlineField);
            if (d < 0) prazoCounts.atrasados.count++;
            else if (d <= 7) prazoCounts.criticos.count++;
            else if (d <= 30) prazoCounts.curtoPrazo.count++;
            else if (d <= 90) prazoCounts.medioPrazo.count++;
            else prazoCounts.longoPrazo.count++;
        });
        
        // Calcula porcentagens para G3 (baseado apenas nos itens ativos)
        Object.keys(prazoCounts).forEach(key => {
            prazoCounts[key].percent = activeCount > 0 ? (prazoCounts[key].count / activeCount) * 100 : 0;
        });
    
        return { totalCount, activeCount, completedCount, overdueCount, statusCounts, setorCounts, prazoCounts };
    }
    
    function renderDashboard() {
        const { totalCount, activeCount, completedCount, overdueCount, statusCounts, setorCounts, prazoCounts } = calculateDashboardData();
        
        // --- Cartões de Resumo ---
        document.getElementById('summaryTotalCount').textContent = totalCount;
        document.getElementById('summaryActiveCount').textContent = activeCount;
        document.getElementById('summaryCompletedCount').textContent = completedCount;
        document.getElementById('summaryOverdueCount').textContent = overdueCount;
    
        // --- G1: Status Consolidado ---
        const listStatusConsolidado = document.getElementById('chartStatusConsolidado');
        listStatusConsolidado.innerHTML = '';
        
        // Ordena os status ativos por contagem
        const sortedStatus = Object.entries(statusCounts).sort(([, a], [, b]) => b.count - a.count);
    
        sortedStatus.forEach(([statusKey, data]) => {
            const count = data.count;
            const percentage = activeCount > 0 ? ((count / activeCount) * 100) : 0;
            const percentageFixed = percentage.toFixed(1);
            const colorVar = colorMap[data.color] || colorMap['default'];
            
            listStatusConsolidado.innerHTML += `
                <li>
                    <div class="chart-list-header">
                        <span class="status-info">
                            <span class="color-dot" style="background-color:${colorVar}"></span>
                            ${statusKey}
                        </span>
                        <div>
                            <span class="value">${count}</span>
                            <span class="percent">(${percentageFixed}%)</span>
                        </div>
                    </div>
                    <div class="chart-bar">
                        <div class="chart-bar-fill" style="width:${percentage}%; background-color:${colorVar}"></div>
                    </div>
                </li>
            `;
        });
        if (listStatusConsolidado.innerHTML === '') {
            listStatusConsolidado.innerHTML = '<li style="text-align:center; padding:20px; flex-direction:row; justify-content:center; border-bottom:none;">Nenhum item ativo encontrado com os filtros atuais.</li>';
        }
    
        // --- G2: Distribuição por Setor ---
        const listDistribuicaoSetor = document.getElementById('chartDistribuicaoSetor');
        listDistribuicaoSetor.innerHTML = '';
        
        const sortedSetores = Object.entries(setorCounts).sort(([, a], [, b]) => b - a);
    
        sortedSetores.forEach(([setor, count]) => {
            const percentage = activeCount > 0 ? ((count / activeCount) * 100) : 0;
            const percentageFixed = percentage.toFixed(1);
            const colorVar = colorMap['default'];
            
            listDistribuicaoSetor.innerHTML += `
                <li>
                    <div class="chart-list-header">
                        <span class="status-info"><i class="fas fa-building" style="margin-right:8px; color:${colorVar}"></i>${setor}</span>
                        <div>
                            <span class="value">${count}</span>
                            <span class="percent">(${percentageFixed}%)</span>
                        </div>
                    </div>
                    <div class="chart-bar">
                        <div class="chart-bar-fill" style="width:${percentage}%; background-color:var(--accent)"></div>
                    </div>
                </li>
            `;
        });
        if (listDistribuicaoSetor.innerHTML === '') {
            listDistribuicaoSetor.innerHTML = '<li style="text-align:center; padding:20px; flex-direction:row; justify-content:center; border-bottom:none;">Nenhum item ativo encontrado com os filtros atuais.</li>';
        }
    
    
        // --- G3: Alerta de Prazos ---
        const listAlertaPrazos = document.getElementById('chartAlertaPrazos');
        
        const prazoData = [
            { label: 'Atrasados (Vencidos)', key: 'atrasados', icon: 'fas fa-exclamation-circle' },
            { label: 'Críticos (0 a 7 dias)', key: 'criticos', icon: 'fas fa-exclamation-triangle' },
            { label: 'Curto Prazo (8 a 30 dias)', key: 'curtoPrazo', icon: 'fas fa-hourglass-start' },
            { label: 'Médio Prazo (31 a 90 dias)', key: 'medioPrazo', icon: 'fas fa-clock' },
            { label: 'Longo Prazo (> 90 dias)', key: 'longoPrazo', icon: 'fas fa-check-circle' }
        ];

        listAlertaPrazos.innerHTML = prazoData.map(item => {
            const data = prazoCounts[item.key];
            const count = data.count;
            const percentage = data.percent;
            const percentageFixed = percentage.toFixed(1);
            const color = data.color;
            const barColor = item.key === 'atrasados' ? 'var(--ind-red)' : (item.key === 'criticos' ? 'var(--ind-yellow)' : 'var(--c-blue)');

            return `
                <li>
                    <div class="chart-list-header">
                        <span class="status-info"><i class="${item.icon}" style="margin-right:8px; color:${color}"></i> ${item.label}</span>
                        <div>
                            <span class="deadline-info" style="color:${color}">${count}</span>
                            <span class="percent">(${percentageFixed}%)</span>
                        </div>
                    </div>
                    <div class="chart-bar">
                        <div class="chart-bar-fill" style="width:${percentage}%; background-color:${barColor}"></div>
                    </div>
                </li>
            `;
        }).join('');
    
        if (activeCount === 0) {
            listAlertaPrazos.innerHTML = '<li style="text-align:center; padding:20px; flex-direction:row; justify-content:center; border-bottom:none;">Nenhum item ativo para análise de prazos com os filtros atuais.</li>';
        }
    }
    
    
    // --- CONFIGURAÇÃO DE DATAS ---
    function populateYearSelects() {
        const years = [];
        for(let i = currentYear - 4; i <= currentYear + 1; i++) {
            years.push(i);
        }
        const options = years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
        
        ['fAuditYearForMonth', 'fAuditYearOnly', 'fAtivYearForMonth', 'fAtivYearOnly', 'fMantYearForMonth', 'fMantYearOnly', 'fDocYearForMonth', 'fDocYearOnly', 'fDashYearForMonth', 'fDashYearOnly'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = options;
        });
    
        ['fAuditMonth', 'fAtivMonth', 'fMantMonth', 'fDocMonth', 'fDashMonth'].forEach(id => {
            document.getElementById(id).value = currentMonth;
        });
    }
    
    function updateDateInputs(prefix) {
        const type = document.getElementById(`f${prefix}DateType`).value;
        document.getElementById(`f${prefix}GroupMonth`).style.display = type === 'month' ? 'flex' : 'none';
        document.getElementById(`f${prefix}YearOnly`).style.display = type === 'year' ? 'block' : 'none';
        document.getElementById(`f${prefix}GroupCustom`).style.display = type === 'custom' ? 'flex' : 'none';
        
        if (prefix === 'Dash') {
            renderDashboard();
        } else {
            renderCards();
        }
    }
    
    // --- RENDERIZAÇÃO DE CARDS E FILTROS ---
    function renderCards() {
        if(currentTab === 'backup' || currentTab === 'dashboard') return; 
    
        const grid = document.getElementById('cardsGrid');
        grid.innerHTML = '';
        
        let data = [];
        let statusList = [];
        let dateField = '';
        let filterCatId = '';
        let filterSubcatId = '';
    
        if (currentTab === 'auditoria') {
            statusList = masterLists.auditStatus || [];
            dateField = 'dataPrevisao';
            filterSetorId = 'fAuditSetor'; 
            filterCatId = 'fAuditCat';
            filterSubcatId = 'fAuditSub';
            
            const setor = document.getElementById(filterSetorId).value; 
            const cat = document.getElementById(filterCatId).value;
            const sub = document.getElementById(filterSubcatId).value;
            const stat = document.getElementById('fAuditStatus').value;
            const dateType = document.getElementById('fAuditDateType').value;
            
            data = audits.filter(item => {
                if (setor && item.setor !== setor) return false; 
                if (cat && item.categoria !== cat) return false;
                if (sub && item.subcategoria !== sub) return false;
                if (stat && item.status !== stat) return false;
                
                if (dateType !== 'all') {
                    const itemDate = new Date(item[dateField]);
                    if (dateType === 'month') {
                        if (itemDate.getMonth() !== parseInt(document.getElementById('fAuditMonth').value) || 
                            itemDate.getFullYear() !== parseInt(document.getElementById('fAuditYearForMonth').value)) return false;
                    } else if (dateType === 'year') {
                        if (itemDate.getFullYear() !== parseInt(document.getElementById('fAuditYearOnly').value)) return false;
                    } else if (dateType === 'custom') {
                        const ini = document.getElementById('fAuditDataIni').value;
                        const fim = document.getElementById('fAuditDataFim').value;
                        if (ini && item[dateField] < ini) return false;
                        if (fim && item[dateField] > fim) return false;
                    }
                }
                return true;
            });
            
        } else if (currentTab === 'atividades') {
            statusList = masterLists.ativStatus || [];
            dateField = 'dataConclusao';
            filterSetorId = 'fAtivSetor'; 
            filterCatId = 'fAtivCat';
            filterSubcatId = 'fAtivSub';
    
            const setor = document.getElementById(filterSetorId).value; 
            const cat = document.getElementById(filterCatId).value;
            const sub = document.getElementById(filterSubcatId).value;
            const stat = document.getElementById('fAtivStatus').value;
            const dateType = document.getElementById('fAtivDateType').value;
    
            data = activities.filter(item => {
                if (setor && item.setor !== setor) return false; 
                if (cat && item.categoria !== cat) return false;
                if (sub && item.subcategoria !== sub) return false;
                if (stat && item.status !== stat) return false;
    
                if (dateType !== 'all') {
                    const itemDate = new Date(item[dateField]);
                    if (dateType === 'month') {
                        if (itemDate.getMonth() !== parseInt(document.getElementById('fAtivMonth').value) || 
                            itemDate.getFullYear() !== parseInt(document.getElementById('fAtivYearForMonth').value)) return false;
                    } else if (dateType === 'year') {
                        if (itemDate.getFullYear() !== parseInt(document.getElementById('fAtivYearOnly').value)) return false;
                    } else if (dateType === 'custom') {
                        const ini = document.getElementById('fAtivDataIni').value;
                        const fim = document.getElementById('fAtivDataFim').value;
                        if (ini && item[dateField] < ini) return false;
                        if (fim && item[dateField] > fim) return false;
                    }
                }
                return true;
            });
    
        } else if (currentTab === 'manutencao') {
            statusList = masterLists.mantStatus || [];
            dateField = 'proxima';
            filterSetorId = 'fMantSetor'; 
            filterCatId = 'fMantCat';
            filterSubcatId = 'fMantItem'; 
    
            const setor = document.getElementById(filterSetorId).value; 
            const cat = document.getElementById(filterCatId).value;
            const itemVal = document.getElementById(filterSubcatId).value;
            const stat = document.getElementById('fMantStatus').value;
            const dateType = document.getElementById('fMantDateType').value;
    
            data = maintenances.filter(item => {
                if (setor && item.setor !== setor) return false; 
                if (cat && item.categoria !== cat) return false;
                if (itemVal && item.item !== itemVal) return false;
                if (stat && item.status !== stat) return false;
    
                if (dateType !== 'all') {
                    const itemDate = new Date(item[dateField]);
                    if (dateType === 'month') {
                        if (itemDate.getMonth() !== parseInt(document.getElementById('fMantMonth').value) || 
                            itemDate.getFullYear() !== parseInt(document.getElementById('fMantYearForMonth').value)) return false;
                    } else if (dateType === 'year') {
                        if (itemDate.getFullYear() !== parseInt(document.getElementById('fMantYearOnly').value)) return false;
                    } else if (dateType === 'custom') {
                        const ini = document.getElementById('fMantDataIni').value;
                        const fim = document.getElementById('fMantDataFim').value;
                        if (ini && item[dateField] < ini) return false;
                        if (fim && item[dateField] > fim) return false;
                    }
                }
                return true;
            });
        } else if (currentTab === 'documentos') { 
            statusList = masterLists.docStatus || [];
            dateField = 'dataProximaRevisao'; 
            filterSetorId = 'fDocSetor'; 
            filterCatId = 'fDocCat';
            filterSubcatId = 'fDocSub';
    
            const setor = document.getElementById(filterSetorId).value; 
            const cat = document.getElementById(filterCatId).value;
            const sub = document.getElementById(filterSubcatId).value;
            const stat = document.getElementById('fDocStatus').value;
            const dateType = document.getElementById('fDocDateType').value;
    
            data = documents.filter(item => {
                if (setor && item.setor !== setor) return false; 
                if (cat && item.categoria !== cat) return false;
                if (sub && item.subcategoria !== sub) return false;
                if (stat && item.status !== stat) return false;
    
                if (dateType !== 'all') {
                    const itemDate = new Date(item[dateField]);
                    if (dateType === 'month') {
                        if (itemDate.getMonth() !== parseInt(document.getElementById('fDocMonth').value) || 
                            itemDate.getFullYear() !== parseInt(document.getElementById('fDocYearForMonth').value)) return false;
                    } else if (dateType === 'year') {
                        if (itemDate.getFullYear() !== parseInt(document.getElementById('fDocYearOnly').value)) return false;
                    } else if (dateType === 'custom') {
                        const ini = document.getElementById('fDocDataIni').value;
                        const fim = document.getElementById('fDocDataFim').value;
                        if (ini && item[dateField] < ini) return false;
                        if (fim && item[dateField] > fim) return false;
                    }
                }
                return true;
            });
        }
    
    
        // ORDENAÇÃO
        if (dateField) {
            data.sort((a, b) => {
                const dateA = new Date(a[dateField]);
                const dateB = new Date(b[dateField]);
                return dateA - dateB;
            });
        }
    
        if(data.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#9ca3af"><i class="fas fa-search fa-2x"></i><p>Nenhum registro encontrado.</p></div>';
            return;
        }
    
        data.forEach(item => {
            const div = document.createElement('div');
            const flagDays = item.flagDias || 7;
            let targetDate;
            
            if (currentTab === 'auditoria') targetDate = item.dataPrevisao;
            else if (currentTab === 'atividades') targetDate = item.dataConclusao;
            else if (currentTab === 'manutencao') targetDate = item.proxima;
            else targetDate = item.dataProximaRevisao; 
    
            const d = daysDiff(targetDate);
            
            let indicatorClass = 'ind-green';
            if (d < 0) indicatorClass = 'ind-red';
            else if (d <= flagDays) indicatorClass = 'ind-yellow';
    
            const statusObj = statusList.find(s => s.name === item.status) || { color: 'default' };
            const statusColorVar = colorMap[statusObj.color] || colorMap['default'];
    
            div.className = `card ${indicatorClass}`;
            div.onclick = () => {
                currentHistoryPage = 1; // Reseta a página ao abrir a visualização
                openView(item.id, currentTab);
            };
    
            let specificContent = '';
            const subcatOrItemValue = currentTab === 'manutencao' ? item.item : item.subcategoria;
            const subcategoryDisplay = subcatOrItemValue ? ` (${subcatOrItemValue})` : '';
    
            if (currentTab === 'auditoria') {
                specificContent = `
                    <div class="card-info-row"><i class="fas fa-building"></i> <span>${item.setor || 'ND'}</span></div>
                    <div class="card-info-row"><i class="far fa-folder"></i> <span>${item.categoria || '-'} ${subcategoryDisplay}</span></div>
                    <div class="card-info-row"><i class="far fa-calendar-check"></i> <span>Prev: <strong>${formatBR(item.dataPrevisao)}</strong></span></div>
                `;
            } else if (currentTab === 'atividades') {
                specificContent = `
                    <div class="card-info-row"><i class="fas fa-building"></i> <span>${item.setor || 'ND'}</span></div>
                    <div class="card-info-row"><i class="far fa-folder"></i> <span>${item.categoria || '-'} ${subcategoryDisplay}</span></div>
                    <div class="card-info-row"><i class="far fa-calendar-check"></i> <span>Fim: <strong>${formatBR(item.dataConclusao)}</strong></span></div>
                `;
            } else if (currentTab === 'manutencao') {
                specificContent = `
                    <div class="card-info-row"><i class="fas fa-building"></i> <span>${item.setor || 'ND'}</span></div>
                    <div class="card-info-row"><i class="far fa-folder"></i> <span>${item.categoria || '-'}</span></div>
                    <div class="card-info-row"><i class="far fa-clock"></i> <span>Próx: <strong>${formatBR(item.proxima)}</strong></span></div>
                `;
            } else { // Documentos
                specificContent = `
                    <div class="card-info-row"><i class="fas fa-building"></i> <span>${item.setor || 'ND'}</span></div>
                    <div class="card-info-row"><i class="far fa-folder"></i> <span>${item.categoria || '-'} ${subcategoryDisplay}</span></div>
                    <div class="card-info-row"><i class="far fa-calendar-check"></i> <span>Rev: <strong>${formatBR(item.dataProximaRevisao)}</strong></span></div>
                `;
            }
    
            div.innerHTML = `
                <div class="card-header">
                    <span class="tag" style="background-color:${statusColorVar}">${item.status || 'Novo'}</span>
                    <div class="card-actions" onclick="event.stopPropagation()">
                        <i class="fas fa-pen" onclick="editItem(${item.id}, '${currentTab}')" title="Editar"></i>
                        <i class="fas fa-trash" onclick="deleteItem(${item.id}, '${currentTab}')" title="Excluir"></i>
                    </div>
                </div>
                <div style="padding:0 10px; margin-bottom:12px;">
                    <h4 title="${item.titulo}">${item.titulo}</h4>
                </div>
                <div class="card-body">
                    ${specificContent}
                </div>
            `;
            grid.appendChild(div);
        });
    }
    
    // Filtro do Dashboard
    function onFilterDashboardChange() {
        if (document.getElementById('fDashDateType').value !== 'all') {
            updateDateInputs('Dash');
        }
        renderDashboard();
    }
    
    // Limpa filtros do Dashboard
    function clearDashboardFilters() {
        document.getElementById('fDashArea').value = "";
        document.getElementById('fDashSetor').value = "";
        document.getElementById('fDashStatus').value = "";
        
        document.getElementById('fDashDateType').value = 'all';
        document.getElementById('fDashDataIni').value = "";
        document.getElementById('fDashDataFim').value = "";
        
        updateDateInputs('Dash');
    }
    
    
    function clearFilters() {
        document.querySelectorAll('.filters-bar select').forEach(s => {
            if(!s.id.includes('DateType') && !s.id.includes('Month') && !s.id.includes('Year')) s.value = "";
        });
        
        document.getElementById('fAuditDateType').value = 'all';
        document.getElementById('fAtivDateType').value = 'all';
        document.getElementById('fMantDateType').value = 'all';
        document.getElementById('fDocDateType').value = 'all'; 
        
        document.querySelectorAll('.filters-bar input').forEach(i => i.value = "");
        
        updateDateInputs('Audit');
        updateDateInputs('Ativ');
        updateDateInputs('Mant');
        updateDateInputs('Doc'); 
        
        onFilterSetorChange('Audit');
        onFilterSetorChange('Ativ');
        onFilterSetorChange('Mant');
        onFilterSetorChange('Doc');
    }
    
    
    function populateSelects() {
        const setores = masterLists.setores || []; 
        
        // NOVO: Coleta TODOS os status de TODAS as listas mestras de status dinamicamente
        let allStatusNames = [];
        ['auditStatus', 'ativStatus', 'mantStatus', 'docStatus'].forEach(key => {
            masterLists[key].forEach(s => {
                if (s.name) allStatusNames.push(s.name);
            });
        });
        const unifiedStatusNames = [...new Set(allStatusNames)].sort();
    
        // Funções auxiliares para gerar <option>
        const makeOpts = (list) => list.map(i => `<option>${i}</option>`).join('');
        const makeStatusOpts = (list) => list.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
        const makeFilterOpts = (list, label) => `<option value="">${label}</option>` + list.map(i => `<option value="${i}">${i}</option>`).join('');
        const makeStatusFilterOpts = (list, label) => `<option value="">${label}</option>` + list.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
        
        // --- FILTROS DASHBOARD ---
        document.getElementById('fDashSetor').innerHTML = makeFilterOpts(setores, "Setor: Todos");
        document.getElementById('fDashStatus').innerHTML = makeFilterOpts(unifiedStatusNames, "Status: Todos");
    
    
        // --- MODAIS ---
        // Setores
        document.getElementById('auditSetor').innerHTML = makeOpts(setores); 
        document.getElementById('ativSetor').innerHTML = makeOpts(setores); 
        document.getElementById('mantSetor').innerHTML = makeOpts(setores); 
        document.getElementById('docSetor').innerHTML = makeOpts(setores); 
    
        // Auditoria
        document.getElementById('auditCategoria').innerHTML = makeOpts(masterLists.auditCategorias);
        document.getElementById('auditStatus').innerHTML = makeStatusOpts(masterLists.auditStatus);
        // Atividades
        document.getElementById('ativCategoria').innerHTML = makeOpts(masterLists.ativCategorias);
        document.getElementById('ativStatus').innerHTML = makeStatusOpts(masterLists.ativStatus);
        // Manutenção
        document.getElementById('mantCategoria').innerHTML = makeOpts(masterLists.mantCategorias);
        document.getElementById('mantStatus').innerHTML = makeStatusOpts(masterLists.mantStatus);
        // Documentos
        document.getElementById('docCategoria').innerHTML = makeOpts(masterLists.docCategorias);
        document.getElementById('docStatus').innerHTML = makeStatusOpts(masterLists.docStatus); 
        
        onCategoryChange('audit');
        onCategoryChange('ativ');
        onCategoryChange('mant');
        onCategoryChange('doc');
    
        // --- FILTROS ABAS (EXISTENTES) ---
        document.getElementById('fAuditSetor').innerHTML = makeFilterOpts(setores, "Setor: Todos"); 
        document.getElementById('fAtivSetor').innerHTML = makeFilterOpts(setores, "Setor: Todos"); 
        document.getElementById('fMantSetor').innerHTML = makeFilterOpts(setores, "Setor: Todos"); 
        document.getElementById('fDocSetor').innerHTML = makeFilterOpts(setores, "Setor: Todos"); 
    
        document.getElementById('fAuditCat').innerHTML = makeFilterOpts(masterLists.auditCategorias, "Categoria: Todas");
        document.getElementById('fAuditStatus').innerHTML = makeStatusFilterOpts(masterLists.auditStatus, "Status: Todos");
        
        document.getElementById('fAtivCat').innerHTML = makeFilterOpts(masterLists.ativCategorias, "Categoria: Todas");
        document.getElementById('fAtivStatus').innerHTML = makeStatusFilterOpts(masterLists.ativStatus, "Status: Todos");
    
        document.getElementById('fMantCat').innerHTML = makeFilterOpts(masterLists.mantCategorias, "Categoria: Todas");
        document.getElementById('fMantStatus').innerHTML = makeStatusFilterOpts(masterLists.mantStatus, "Status: Todos");
        
        document.getElementById('fDocCat').innerHTML = makeFilterOpts(masterLists.docCategorias, "Categoria: Todas"); 
        document.getElementById('fDocStatus').innerHTML = makeStatusFilterOpts(masterLists.docStatus, "Status: Todos"); 
        
        onFilterCategoryChange('Audit');
        onFilterCategoryChange('Ativ');
        onFilterCategoryChange('Mant');
        onFilterCategoryChange('Doc');
    }
    
    // Funções auxiliares para obter prefixos de ID corretos
    function getTabPrefix(tab) {
        if (tab === 'auditoria') return 'audit';
        if (tab === 'atividades') return 'ativ';
        if (tab === 'manutencao') return 'mant';
        if (tab === 'documentos') return 'doc';
        return '';
    }
    
    // Funções de atualização em cascata para MODAIS (Setor não interfere, mantido apenas para CategoryChange)
    function onCategoryChange(prefix) {
        const catSelect = document.getElementById(`${prefix}Categoria`);
        let subcatSelect;
        let listKey;
        
        if (prefix === 'mant') {
            subcatSelect = document.getElementById(`${prefix}Item`);
            listKey = 'mantItens';
        } else {
            subcatSelect = document.getElementById(`${prefix}Sub`);
            listKey = `${prefix}Subcats`;
        }
        
        if (!subcatSelect) return; 
    
        const selectedCat = catSelect.value;
        const currentSubcat = subcatSelect.value; 
        
        if (!selectedCat) {
            subcatSelect.innerHTML = `<option value="">${prefix === 'mant' ? 'Nenhum Item' : 'Nenhuma Subcategoria'}</option>`;
            return;
        }
    
        const subcats = masterLists[listKey][selectedCat] || [];
        
        subcatSelect.innerHTML = subcats.map(i => `<option value="${i}">${i}</option>`).join('') || 
                                 `<option value="">${prefix === 'mant' ? 'Nenhum Item' : 'Nenhuma Subcategoria'}</option>`;
    
        if (subcats.includes(currentSubcat)) subcatSelect.value = currentSubcat;
    }
    
    // NOVO: Filtro de Setor (Setor NÃO afeta a Categoria no cadastro/filtro)
    function onFilterSetorChange(prefix) {
        renderCards();
    }
    
    // Funções de atualização em cascata para FILTROS
    function onFilterCategoryChange(prefix) {
        const catSelect = document.getElementById(`f${prefix}Cat`);
        let subcatSelect;
        let listKey;
        let label;
        
        if (prefix === 'Mant') {
            subcatSelect = document.getElementById(`f${prefix}Item`);
            listKey = 'mantItens';
            label = 'Item: Todos';
        } else {
            subcatSelect = document.getElementById(`f${prefix}Sub`);
            listKey = `${prefix.toLowerCase()}Subcats`;
            label = 'Subcategoria: Todas';
        }
        
        if (!subcatSelect) return; 
    
        const selectedCat = catSelect.value;
        const currentSubcat = subcatSelect.value;
        
        let subcats = [];
    
        if (selectedCat === "") {
            let allSubcats = [];
            if (prefix === 'Audit') allSubcats = audits.map(i => i.subcategoria).filter(Boolean);
            else if (prefix === 'Ativ') allSubcats = activities.map(i => i.subcategoria).filter(Boolean);
            else if (prefix === 'Mant') allSubcats = maintenances.map(i => i.item).filter(Boolean);
            else if (prefix === 'Doc') allSubcats = documents.map(i => i.subcategoria).filter(Boolean);
            
            subcats = [...new Set(allSubcats)].sort();
    
        } else {
            subcats = masterLists[listKey][selectedCat] || [];
        }
        
        subcatSelect.innerHTML = `<option value="">${label}</option>` + subcats.map(i => `<option value="${i}">${i}</option>`).join('');
    
        if (subcats.includes(currentSubcat)) subcatSelect.value = currentSubcat;
    
        renderCards();
    }
    
    // Função de cálculo para Manutenção e Documentos (Periodicidade)
    function calculateNextDate(prefix = 'mant') {
        let ultima, intervaloId, proximaDisplayId, intervalValue;
    
        if (prefix === 'mant') {
            ultima = document.getElementById('mantUltima').value;
            intervaloId = 'mantIntervalo';
            proximaDisplayId = 'mantProxima';
            intervalValue = parseInt(document.getElementById(intervaloId).value) || 0;
        } else if (prefix === 'doc') {
            ultima = document.getElementById('docDataCriacao').value; 
            intervaloId = 'docIntervalo';
            proximaDisplayId = 'docProximaRevisao';
            intervalValue = parseInt(document.getElementById(intervaloId).value) || 0;
        } else {
            return;
        }
        
        if (ultima) {
            const next = new Date(ultima);
            next.setDate(next.getDate() + intervalValue);
            const nextStr = next.toISOString().split('T')[0];
            document.getElementById(proximaDisplayId).textContent = formatBR(nextStr);
        }
    }
    
    // --- TAB CONTROL ---
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
        
        const tabId = 'tab' + tab.charAt(0).toUpperCase() + tab.slice(1);
        const btn = document.getElementById(tabId);
        if(btn) btn.classList.add('active');
        
        const titles = { 
            dashboard: 'Dashboard', 
            auditoria: 'Auditoria', 
            atividades: 'Gestão de Atividades', 
            manutencao: 'Manutenção',
            documentos: 'Documentos', 
            backup: 'Backup do Sistema'
        };
        const subtitles = { 
            dashboard: 'Visão geral e indicadores de desempenho', 
            auditoria: 'Planejamento e execução de auditorias', 
            atividades: 'Controle de tarefas, reuniões e projetos',
            manutencao: 'Controle preventivo de equipamentos',
            documentos: 'Gerenciamento e controle de revisões', 
            backup: 'Segurança dos dados'
        };
        
        document.getElementById('pageTitle').textContent = titles[tab];
        document.getElementById('pageSubtitle').textContent = subtitles[tab];
        
        const isBackup = tab === 'backup';
        const isDashboard = tab === 'dashboard';
    
        document.getElementById('filtersBar').style.display = (isBackup || isDashboard) ? 'none' : 'flex';
        document.getElementById('filtersBarDashboard').style.display = isDashboard ? 'flex' : 'none';
        document.getElementById('cardsGrid').style.display = (isBackup || isDashboard) ? 'none' : 'grid';
        document.getElementById('addBtn').style.display = (isBackup || isDashboard) ? 'none' : 'flex';
        
        document.getElementById('backupContent').style.display = isBackup ? 'flex' : 'none';
        document.getElementById('dashboardContent').style.display = isDashboard ? 'flex' : 'none'; 
    
        document.getElementById('filtersAuditoria').style.display = tab === 'auditoria' ? 'flex' : 'none';
        document.getElementById('filtersAtividades').style.display = tab === 'atividades' ? 'flex' : 'none';
        document.getElementById('filtersManutencao').style.display = tab === 'manutencao' ? 'flex' : 'none';
        document.getElementById('filtersDocumentos').style.display = tab === 'documentos' ? 'flex' : 'none'; 
        
        if(isDashboard) {
            renderDashboard();
        } else if(!isBackup) {
            clearFilters();
        }
    }
    
    document.getElementById('tabDashboard').onclick = () => switchTab('dashboard'); 
    document.getElementById('tabAuditoria').onclick = () => switchTab('auditoria');
    document.getElementById('tabAtividades').onclick = () => switchTab('atividades');
    document.getElementById('tabManutencao').onclick = () => switchTab('manutencao');
    document.getElementById('tabDocumentos').onclick = () => switchTab('documentos'); 
    document.getElementById('tabBackup').onclick = () => switchTab('backup');
    
// --- MODAL & FORM LOGIC (CORRIGIDA) ---

function resetModal(prefix) {
    // 1. Resetar campos comuns
    document.getElementById(`${prefix}Titulo`).value = '';
    document.getElementById(`${prefix}Descricao`).value = '';
    document.getElementById(`${prefix}Anexos`).innerHTML = '';

    // Lida com Responsáveis
    const respEl = document.getElementById(`${prefix}Responsavel`);
    if (respEl) respEl.value = '';
    
    // Define o Setor
    const defaultSetor = masterLists.setores[0] || '';
    document.getElementById(`${prefix}Setor`).value = defaultSetor;
    
    // Define o Status (seleciona o primeiro, se houver)
    if (document.getElementById(`${prefix}Status`).options.length > 0) {
        document.getElementById(`${prefix}Status`).selectedIndex = 0;
    }

    // 2. Resetar campos específicos e cálculos

    if (prefix === 'audit') {
        document.getElementById('auditDataPublicacao').value = today();
        document.getElementById('auditDataPrevisao').value = today();
        document.getElementById('auditFlagDias').value = 7;
        const defaultAuditCat = masterLists.auditCategorias[0] || '';
        document.getElementById('auditCategoria').value = defaultAuditCat;
    } else if (prefix === 'ativ') {
        document.getElementById('ativDataInicio').value = today();
        document.getElementById('ativDataConclusao').value = today();
        document.getElementById('ativFlagDias').value = 3;
        const defaultAtivCat = masterLists.ativCategorias[0] || '';
        document.getElementById('ativCategoria').value = defaultAtivCat;
    } else if (prefix === 'mant') {
        document.getElementById('mantUltima').value = today();
        document.getElementById('mantIntervalo').value = 30;
        document.getElementById('mantResponsavelTecnico').value = '';
        document.getElementById('mantResponsavelManutencao').value = '';
        document.getElementById('mantFlagDias').value = 7;
        const defaultMantCat = masterLists.mantCategorias[0] || '';
        document.getElementById('mantCategoria').value = defaultMantCat;
        calculateNextDate('mant');
    } else if (prefix === 'doc') {
        document.getElementById('docDataCriacao').value = today();
        document.getElementById('docIntervalo').value = 365;
        document.getElementById('docRevisor').value = '';
        document.getElementById('docFlagDias').value = 30;
        const defaultDocCat = masterLists.docCategorias[0] || '';
        document.getElementById('docCategoria').value = defaultDocCat;
        calculateNextDate('doc');
    }

    // 3. Chamar onCategoryChange após definir a categoria (se a categoria existir)
    const catEl = document.getElementById(`${prefix}Categoria`);
    if (catEl) onCategoryChange(prefix);
}


document.getElementById('addBtn').onclick = () => {
    // Limpa o item original para garantir que um novo item não registre "mudanças"
    originalItem = null;

    if (currentTab === 'auditoria') {
        editingAuditId = null;
        resetModal('audit');
        document.getElementById('modalAuditoria').style.display = 'flex';
    } else if (currentTab === 'atividades') {
        editingAtivId = null;
        resetModal('ativ');
        document.getElementById('modalAtividades').style.display = 'flex';
    } else if (currentTab === 'manutencao') {
        editingMantId = null;
        resetModal('mant');
        document.getElementById('modalManutencao').style.display = 'flex';
    } else if (currentTab === 'documentos') { 
        editingDocId = null;
        resetModal('doc');
        document.getElementById('modalDocumentos').style.display = 'flex';
    }
};

    document.getElementById('addBtn').onclick = () => {
        originalItem = null;
    
        if (currentTab === 'auditoria') {
            editingAuditId = null;
            resetModal('audit');
            document.getElementById('modalAuditoria').style.display = 'flex';
        } else if (currentTab === 'atividades') {
            editingAtivId = null;
            resetModal('ativ');
            document.getElementById('modalAtividades').style.display = 'flex';
        } else if (currentTab === 'manutencao') {
            editingMantId = null;
            resetModal('mant');
            document.getElementById('modalManutencao').style.display = 'flex';
        } else if (currentTab === 'documentos') { 
            editingDocId = null;
            resetModal('doc');
            document.getElementById('modalDocumentos').style.display = 'flex';
        }
    };
    
    
    // SAVE FUNCTIONS
    function saveAudit() {
        const isNew = !editingAuditId;
        // Se for edição, busca o item original para garantir que o 'item' não perca o histórico se não houver mudanças nos campos principais
        let item = isNew ? { id: Date.now(), historico: [], type: 'audit' } : audits.find(a => a.id === editingAuditId);

        const newItem = {
            ...item,
            titulo: document.getElementById('auditTitulo').value,
            descricao: document.getElementById('auditDescricao').value,
            setor: document.getElementById('auditSetor').value, 
            categoria: document.getElementById('auditCategoria').value,
            subcategoria: document.getElementById('auditSub').value, 
            status: document.getElementById('auditStatus').value,
            dataPublicacao: document.getElementById('auditDataPublicacao').value,
            dataPrevisao: document.getElementById('auditDataPrevisao').value,
            responsavel: document.getElementById('auditResponsavel').value, 
            flagDias: +document.getElementById('auditFlagDias').value, // Lê o valor como número
            anexos: getAnexos('audit')
        };

        if (isNew) {
            newItem.historico.push({ timestamp: new Date().toISOString(), acao: 'Criação do Registro' });
            audits.push(newItem);
        } else {
            const changes = calculateChanges(originalItem, newItem);
            if (changes.length > 0) {
                newItem.historico.push({ 
                    timestamp: new Date().toISOString(), 
                    acao: 'Edição de Dados', 
                    detalhes: changes 
                });
            } else {
                // Se não houve alteração, mantém o item original na lista (evita perda de dados)
                audits = audits.map(a => a.id === editingAuditId ? item : a);
                closeModal('modalAuditoria');
                return;
            }
            audits = audits.map(a => a.id === editingAuditId ? newItem : a);
        }

        saveAll(); closeModal('modalAuditoria'); renderCards();
    }
    
    function saveAtividade() {
        const isNew = !editingAtivId;
        // Se for edição, busca o item original para garantir que o 'item' não perca o histórico se não houver mudanças nos campos principais
        let item = isNew ? { id: Date.now(), historico: [], type: 'ativ' } : activities.find(a => a.id === editingAtivId);

        const newItem = {
            ...item,
            titulo: document.getElementById('ativTitulo').value,
            descricao: document.getElementById('ativDescricao').value,
            setor: document.getElementById('ativSetor').value, 
            categoria: document.getElementById('ativCategoria').value,
            subcategoria: document.getElementById('ativSub').value, 
            status: document.getElementById('ativStatus').value,
            dataInicio: document.getElementById('ativDataInicio').value,
            dataConclusao: document.getElementById('ativDataConclusao').value,
            responsavel: document.getElementById('ativResponsavel').value, 
            flagDias: +document.getElementById('ativFlagDias').value, // Lê o valor como número
            anexos: getAnexos('ativ')
        };
        
        if (isNew) {
            newItem.historico.push({ timestamp: new Date().toISOString(), acao: 'Criação do Registro' });
            activities.push(newItem);
        } else {
            const changes = calculateChanges(originalItem, newItem);
            if (changes.length > 0) {
                newItem.historico.push({ 
                    timestamp: new Date().toISOString(), 
                    acao: 'Edição de Dados', 
                    detalhes: changes 
                });
            } else {
                activities = activities.map(a => a.id === editingAtivId ? item : a);
                closeModal('modalAtividades');
                return;
            }
            activities = activities.map(a => a.id === editingAtivId ? newItem : a);
        }

        saveAll(); closeModal('modalAtividades'); renderCards();
    }
    
    function saveManutencao() {
        const ultima = document.getElementById('mantUltima').value;
        const intervalo = parseInt(document.getElementById('mantIntervalo').value) || 0; // Garante que seja um número
        
        // Recálculo da próxima data com o NOVO intervalo
        const nextDate = new Date(ultima);
        nextDate.setDate(nextDate.getDate() + intervalo);
        
        const isNew = !editingMantId;
        // Se for edição, busca o item original para garantir que o 'item' não perca o histórico se não houver mudanças nos campos principais
        let item = isNew ? { id: Date.now(), historico: [], type: 'mant' } : maintenances.find(m => m.id === editingMantId);

        const newItem = {
            ...item,
            titulo: document.getElementById('mantTitulo').value,
            descricao: document.getElementById('mantDescricao').value,
            setor: document.getElementById('mantSetor').value, 
            categoria: document.getElementById('mantCategoria').value,
            item: document.getElementById('mantItem').value, 
            ultima,
            intervalo, // Salva o novo intervalo
            proxima: nextDate.toISOString().split('T')[0], // Salva a nova data calculada
            responsavelTecnico: document.getElementById('mantResponsavelTecnico').value, 
            responsavelManutencao: document.getElementById('mantResponsavelManutencao').value, 
            status: document.getElementById('mantStatus').value,
            flagDias: +document.getElementById('mantFlagDias').value, // Lê o valor como número
            anexos: getAnexos('mant')
        };

        if (isNew) {
            newItem.historico.push({ timestamp: new Date().toISOString(), acao: 'Criação do Registro' });
            maintenances.push(newItem);
        } else {
            const changes = calculateChanges(originalItem, newItem);
            if (changes.length > 0) {
                newItem.historico.push({ 
                    timestamp: new Date().toISOString(), 
                    acao: 'Edição de Dados', 
                    detalhes: changes 
                });
            } else {
                maintenances = maintenances.map(m => m.id === editingMantId ? item : m);
                closeModal('modalManutencao');
                return;
            }
            maintenances = maintenances.map(m => m.id === editingMantId ? newItem : m);
        }

        saveAll(); closeModal('modalManutencao'); renderCards();
    }
    
    function saveDocumento() { 
        const dataCriacao = document.getElementById('docDataCriacao').value;
        const docIntervalo = parseInt(document.getElementById('docIntervalo').value) || 0; // Garante que seja um número
        
        // Recálculo da próxima revisão com o NOVO intervalo
        const nextRevisao = new Date(dataCriacao);
        nextRevisao.setDate(nextRevisao.getDate() + docIntervalo);
        
        const isNew = !editingDocId;
        // Se for edição, busca o item original para garantir que o 'item' não perca o histórico se não houver mudanças nos campos principais
        let item = isNew ? { id: Date.now(), historico: [], type: 'doc' } : documents.find(d => d.id === editingDocId);

        const newItem = {
            ...item,
            titulo: document.getElementById('docTitulo').value,
            descricao: document.getElementById('docDescricao').value,
            setor: document.getElementById('docSetor').value, 
            categoria: document.getElementById('docCategoria').value,
            subcategoria: document.getElementById('docSub').value, 
            status: document.getElementById('docStatus').value,
            dataCriacao,
            docIntervalo, // Salva o novo intervalo
            dataProximaRevisao: nextRevisao.toISOString().split('T')[0], // Salva a nova data calculada
            responsavel: document.getElementById('docResponsavel').value,
            revisor: document.getElementById('docRevisor').value,
            flagDias: +document.getElementById('docFlagDias').value, // Lê o valor como número
            anexos: getAnexos('doc')
        };

        if (isNew) {
            newItem.historico.push({ timestamp: new Date().toISOString(), acao: 'Criação do Registro' });
            documents.push(newItem);
        } else {
            const changes = calculateChanges(originalItem, newItem);
            if (changes.length > 0) {
                newItem.historico.push({ 
                    timestamp: new Date().toISOString(), 
                    acao: 'Edição de Dados', 
                    detalhes: changes 
                });
            } else {
                documents = documents.map(d => d.id === editingDocId ? item : d);
                closeModal('modalDocumentos');
                return;
            }
            documents = documents.map(d => d.id === editingDocId ? newItem : d);
        }

        saveAll(); closeModal('modalDocumentos'); renderCards();
    }
    function editItem(id, tab) {
        let item;
        if (tab === 'auditoria') {
            item = audits.find(a => a.id === id);
            editingAuditId = id;
            document.getElementById('auditTitulo').value = item.titulo;
            document.getElementById('auditDescricao').value = item.descricao;
            document.getElementById('auditSetor').value = item.setor || ''; 
            document.getElementById('auditCategoria').value = item.categoria;
            onCategoryChange('audit'); 
            document.getElementById('auditSub').value = item.subcategoria || ''; 
            document.getElementById('auditStatus').value = item.status;
            document.getElementById('auditDataPublicacao').value = item.dataPublicacao;
            document.getElementById('auditDataPrevisao').value = item.dataPrevisao;
            document.getElementById('auditResponsavel').value = item.responsavel || ''; 
            document.getElementById('auditFlagDias').value = item.flagDias; // Corrigido
            restoreAnexos('audit', item.anexos);
            document.getElementById('modalAuditoria').style.display = 'flex';
        } else if (tab === 'atividades') {
            item = activities.find(a => a.id === id);
            editingAtivId = id;
            document.getElementById('ativTitulo').value = item.titulo;
            document.getElementById('ativDescricao').value = item.descricao;
            document.getElementById('ativSetor').value = item.setor || ''; 
            document.getElementById('ativCategoria').value = item.categoria;
            onCategoryChange('ativ'); 
            document.getElementById('ativSub').value = item.subcategoria || ''; 
            document.getElementById('ativStatus').value = item.status;
            document.getElementById('ativDataInicio').value = item.dataInicio;
            document.getElementById('ativDataConclusao').value = item.dataConclusao;
            document.getElementById('ativResponsavel').value = item.responsavel || ''; 
            document.getElementById('ativFlagDias').value = item.flagDias; // Corrigido
            restoreAnexos('ativ', item.anexos);
            document.getElementById('modalAtividades').style.display = 'flex';
        } else if (tab === 'manutencao') {
            item = maintenances.find(m => m.id === id);
            editingMantId = id;
            document.getElementById('mantTitulo').value = item.titulo;
            document.getElementById('mantDescricao').value = item.descricao;
            document.getElementById('mantSetor').value = item.setor || ''; 
            document.getElementById('mantCategoria').value = item.categoria;
            onCategoryChange('mant'); 
            document.getElementById('mantItem').value = item.item;
            document.getElementById('mantUltima').value = item.ultima;
            document.getElementById('mantIntervalo').value = item.intervalo; // Corrigido
            document.getElementById('mantResponsavelTecnico').value = item.responsavelTecnico || ''; 
            document.getElementById('mantResponsavelManutencao').value = item.responsavelManutencao || ''; 
            document.getElementById('mantStatus').value = item.status;
            document.getElementById('mantFlagDias').value = item.flagDias; // Corrigido
            calculateNextDate('mant');
            restoreAnexos('mant', item.anexos);
            document.getElementById('modalManutencao').style.display = 'flex';
        } else if (tab === 'documentos') { 
            item = documents.find(d => d.id === id);
            editingDocId = id;
            document.getElementById('docTitulo').value = item.titulo;
            document.getElementById('docDescricao').value = item.descricao;
            document.getElementById('docSetor').value = item.setor || ''; 
            document.getElementById('docCategoria').value = item.categoria;
            onCategoryChange('doc'); 
            document.getElementById('docSub').value = item.subcategoria || ''; 
            document.getElementById('docStatus').value = item.status;
            document.getElementById('docDataCriacao').value = item.dataCriacao;
            document.getElementById('docIntervalo').value = item.docIntervalo; // Corrigido
            document.getElementById('docResponsavel').value = item.responsavel || '';
            document.getElementById('docRevisor').value = item.revisor || '';
            document.getElementById('docFlagDias').value = item.flagDias; // Corrigido
            calculateNextDate('doc');
            restoreAnexos('doc', item.anexos);
            document.getElementById('modalDocumentos').style.display = 'flex';
        }

        // Armazena o item original no estado atual para calcular as diferenças ao salvar
        originalItem = JSON.parse(JSON.stringify(item));
    }

    function deleteItem(id, tab) {
        if (!confirm('Deseja realmente excluir este registro?')) return;
        if (tab === 'auditoria') audits = audits.filter(a => a.id !== id);
        else if (tab === 'atividades') activities = activities.filter(a => a.id !== id);
        else if (tab === 'manutencao') maintenances = maintenances.filter(m => m.id !== id);
        else if (tab === 'documentos') documents = documents.filter(d => d.id !== id); 
        saveAll();
        renderCards();
    }
    
    // Anexos Logic
    function addAnexo(prefix) {
        const container = document.getElementById(prefix + 'Anexos');
        const div = document.createElement('div');
        div.className = 'anexo-item';
        div.innerHTML = `
            <i class="fas fa-link"></i>
            <input placeholder="Título do arquivo" class="anexo-title">
            <input placeholder="Cole a URL aqui..." class="anexo-url">
            <i class="fas fa-times" style="cursor:pointer; color:var(--ind-red)" onclick="this.parentElement.remove()"></i>
        `;
        container.appendChild(div);
    }
    function getAnexos(prefix) {
        return [...document.querySelectorAll(`#${prefix}Anexos .anexo-item`)].map(row => ({
            titulo: row.querySelector('.anexo-title').value,
            url: row.querySelector('.anexo-url').value
        })).filter(a => a.url);
    }
    function restoreAnexos(prefix, list) {
        const container = document.getElementById(prefix + 'Anexos');
        container.innerHTML = '';
        (list || []).forEach(a => {
            addAnexo(prefix);
            const row = container.lastChild;
            row.querySelector('.anexo-title').value = a.titulo;
            row.querySelector('.anexo-url').value = a.url;
        });
    }
    
    // View Modal e Histórico com Paginação
    function openView(id, tab) {
        currentHistoryPage = 1; // Garante que a primeira página seja carregada
        renderViewContent(id, tab);
    }
    
    function changeHistoryPage(id, tab, direction) {
        currentHistoryPage += direction;
        renderViewContent(id, tab);
    }

    function renderViewContent(id, tab) {
        let item, statusList;
        if (tab === 'auditoria') { item = audits.find(i => i.id === id); statusList = masterLists.auditStatus; }
        else if (tab === 'atividades') { item = activities.find(i => i.id === id); statusList = masterLists.ativStatus; }
        else if (tab === 'manutencao') { item = maintenances.find(i => i.id === id); statusList = masterLists.mantStatus; }
        else if (tab === 'documentos') { item = documents.find(i => i.id === id); statusList = masterLists.docStatus; } 
    
        if (!item) return;
    
        const statusObj = (statusList || []).find(s => s.name === item.status) || { color: 'default' };
        const statusColorVar = colorMap[statusObj.color] || colorMap['default'];
        
        // Adiciona Subcategoria/Item (Manutenção) na exibição
        const subcatOrItemLabel = tab === 'manutencao' ? 'Equipamento' : 'Subcategoria';
        const subcatOrItemValue = tab === 'manutencao' ? item.item : item.subcategoria;
        
        // Determina o prefixo para usar no fieldNames
        const prefix = getTabPrefix(tab);
    
        let detailsGrid = '';
        if (tab === 'auditoria') {
            detailsGrid = `
                <div class="view-item"><label>Setor</label><div>${item.setor || 'ND'}</div></div>
                <div class="view-item"><label>Categoria</label><div>${item.categoria}</div></div>
                <div class="view-item"><label>${subcatOrItemLabel}</label><div>${subcatOrItemValue || 'ND'}</div></div>
                <div class="view-item"><label>Responsável</label><div>${item.responsavel || 'ND'}</div></div>
                <div class="view-item"><label>Publicação</label><div>${formatBR(item.dataPublicacao)}</div></div>
                <div class="view-item"><label>Previsão</label><div>${formatBR(item.dataPrevisao)}</div></div>
                <div class="view-item"><label>Alerta</label><div>${item.flagDias} dias antes</div></div>
            `;
        } else if (tab === 'atividades') {
            detailsGrid = `
                <div class="view-item"><label>Setor</label><div>${item.setor || 'ND'}</div></div>
                <div class="view-item"><label>Categoria</label><div>${item.categoria}</div></div>
                <div class="view-item"><label>${subcatOrItemLabel}</label><div>${subcatOrItemValue || 'ND'}</div></div>
                <div class="view-item"><label>Responsável</label><div>${item.responsavel || 'ND'}</div></div>
                <div class="view-item"><label>Data Início</label><div>${formatBR(item.dataInicio)}</div></div>
                <div class="view-item"><label>Data Conclusão</label><div>${formatBR(item.dataConclusao)}</div></div>
                <div class="view-item"><label>Alerta</label><div>${item.flagDias} dias antes</div></div>
            `;
        } else if (tab === 'manutencao') {
            detailsGrid = `
                <div class="view-item"><label>Setor</label><div>${item.setor || 'ND'}</div></div>
                <div class="view-item"><label>Categoria</label><div>${item.categoria}</div></div>
                <div class="view-item"><label>Equipamento</label><div>${item.item}</div></div>
                <div class="view-item"><label>Periodicidade</label><div>${item.intervalo} dias</div></div>
                <div class="view-item"><label>Última Manutenção</label><div>${formatBR(item.ultima)}</div></div>
                <div class="view-item"><label>Próxima Manutenção</label><div>${formatBR(item.proxima)}</div></div>
                <div class="view-item"><label>Responsável Técnico</label><div>${item.responsavelTecnico || 'ND'}</div></div>
                <div class="view-item"><label>Responsável pela Manutenção</label><div>${item.responsavelManutencao || 'ND'}</div></div>
                <div class="view-item"><label>Alerta</label><div>${item.flagDias} dias antes</div></div>
            `;
        } else if (tab === 'documentos') { 
            detailsGrid = `
                <div class="view-item"><label>Setor</label><div>${item.setor || 'ND'}</div></div>
                <div class="view-item"><label>Categoria</label><div>${item.categoria}</div></div>
                <div class="view-item"><label>${subcatOrItemLabel}</label><div>${subcatOrItemValue || 'ND'}</div></div>
                <div class="view-item"><label>Periodicidade</label><div>${item.docIntervalo} dias</div></div>
                <div class="view-item"><label>Responsável</label><div>${item.responsavel || 'ND'}</div></div>
                <div class="view-item"><label>Revisor</label><div>${item.revisor || 'ND'}</div></div>
                <div class="view-item"><label>Data Criação</label><div>${formatBR(item.dataCriacao)}</div></div>
                <div class="view-item"><label>Próx. Revisão</label><div>${formatBR(item.dataProximaRevisao)}</div></div>
                <div class="view-item"><label>Alerta</label><div>${item.flagDias} dias antes</div></div>
            `;
        }
    
        const anexosHtml = (item.anexos || []).map(a => 
            `<a href="${a.url}" target="_blank" class="file-chip"><i class="fas fa-external-link-alt"></i> ${a.titulo || 'Anexo'}</a>`
        ).join('');

        // LÓGICA DE PAGINAÇÃO DO HISTÓRICO
        const allHistory = (item.historico || []).slice().reverse(); // Copia e inverte para o mais recente primeiro
        const itemsPerPage = 5;
        const totalItems = allHistory.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        
        // Limita a 5 páginas
        const maxPages = 5;
        const finalPages = Math.min(totalPages, maxPages);
        
        // Garante que a página atual seja válida
        currentHistoryPage = Math.min(Math.max(1, currentHistoryPage), finalPages);
        
        const start = (currentHistoryPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedHistory = allHistory.slice(start, end);

        const historyHtml = paginatedHistory.map(h => {
            const date = new Date(h.timestamp);
            const dateStr = date.toLocaleDateString('pt-BR');
            const timeStr = date.toLocaleTimeString('pt-BR');
            
            let details = '';
            if (h.detalhes && h.detalhes.length > 0) {
                details = h.detalhes.map(d => `<small style="margin-left:10px;">${d}</small>`).join('');
            } else if (h.acao.includes('Edição') || h.acao.includes('Atualização')) {
                 details = '<small style="margin-left:10px; color: var(--ind-yellow);">Detalhes não registrados nesta versão.</small>';
            }
            
            return `
                <div class="history-item">
                    <strong>${h.acao}</strong>
                    <small>${dateStr} às ${timeStr}</small>
                    ${details}
                </div>
            `;
        }).join('');
        
        const paginationHtml = finalPages > 1 ? `
            <div class="history-pagination">
                <button ${currentHistoryPage === 1 ? 'disabled' : ''} onclick="changeHistoryPage(${id}, '${tab}', -1)">
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <span>Página ${currentHistoryPage} de ${finalPages}</span>
                <button ${currentHistoryPage === finalPages ? 'disabled' : ''} onclick="changeHistoryPage(${id}, '${tab}', 1)">
                    Próxima <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        ` : '';

        const historySection = `
            <div class="view-history">
                <h4><i class="fas fa-history"></i> Histórico de Edições (${totalItems} itens)</h4>
                ${historyHtml || '<div style="color:var(--text-light); font-size:13px;">Nenhuma alteração registrada.</div>'}
                ${paginationHtml}
            </div>
        `;

        const html = `
            <div class="view-header">
                <h2 style="margin:0; color:var(--primary)">${item.titulo}</h2>
                <span class="view-status" style="background-color:${statusColorVar}">${item.status}</span>
            </div>
            <div class="view-grid">
                ${detailsGrid}
            </div>
            <div>
                <h4 style="margin:0 0 8px; color:#6b7280; font-size:12px; text-transform:uppercase">Descrição Detalhada</h4>
                <div class="view-desc">${item.descricao || 'Sem descrição.'}</div>
            </div>
            ${anexosHtml ? `<div class="view-files"><h4>Anexos</h4>${anexosHtml}</div>` : ''}
            ${historySection}
        `;
        
        document.getElementById('viewContent').innerHTML = html;
        document.getElementById('viewModal').style.display = 'flex';
    }
    
    // List Manager & Color Selection
    function openListManager(genericKey) {
        let isStatus = false;
        let listName;
        
        if (genericKey === 'setores') { 
            currentListKey = 'setores';
            listName = 'SETORES';
        } else if (genericKey === 'categorias') {
            if(currentTab === 'auditoria') currentListKey = 'auditCategorias';
            else if(currentTab === 'atividades') currentListKey = 'ativCategorias';
            else if(currentTab === 'manutencao') currentListKey = 'mantCategorias';
            else currentListKey = 'docCategorias'; 
            listName = 'CATEGORIA';
        } else if (genericKey === 'subcategorias' || genericKey === 'itens') { 
            
            const prefix = getTabPrefix(currentTab); 
            const catSelect = document.getElementById(`${prefix}Categoria`);
            
            if (!catSelect) { 
                 alert(`Elemento de Categoria (${prefix}Categoria) não encontrado. Verifique se você abriu o modal correspondente à aba ativa.`); 
                 return; 
            }
    
            const cat = catSelect.value;
            
            if (!cat) { alert("Selecione uma Categoria antes de gerenciar Subcategorias/Itens."); return; }
            
            let subcatMapKey;
            if(currentTab === 'auditoria') subcatMapKey = 'auditSubcats';
            else if(currentTab === 'atividades') subcatMapKey = 'ativSubcats';
            else if(currentTab === 'manutencao') subcatMapKey = 'mantItens';
            else subcatMapKey = 'docSubcats';
            
            currentListKey = `${subcatMapKey}_${cat}`; 
            listName = `SUBCATEGORIAS / ITENS DE: ${cat}`;
            
        } else if (genericKey === 'status') {
            if(currentTab === 'auditoria') currentListKey = 'auditStatus';
            else if(currentTab === 'atividades') currentListKey = 'ativStatus';
            else if(currentTab === 'manutencao') currentListKey = 'mantStatus';
            else currentListKey = 'docStatus';
            isStatus = true;
            listName = 'STATUS';
        } else {
            currentListKey = genericKey; 
            listName = genericKey.toUpperCase();
        }
        
        document.getElementById('listTitle').textContent = `Gerenciar: ${listName}`;
        const body = document.getElementById('listBody');
        body.innerHTML = '';
    
        if(isStatus) {
            document.getElementById('colorPickerContainer').style.display = 'block';
            selectColor('default', document.querySelector('.bg-default')); 
        } else {
            document.getElementById('colorPickerContainer').style.display = 'none';
        }
    
        let listToRender;
        let baseKey = currentListKey.split('_')[0]; 
    
        if (currentListKey.includes('_')) { 
            const cat = currentListKey.split('_')[1];
            masterLists[baseKey] = masterLists[baseKey] || {}; 
            listToRender = masterLists[baseKey][cat] || [];
        } else {
            listToRender = masterLists[currentListKey] || [];
        }
        
        listToRender.forEach(val => {
            let displayHtml = '', itemVal = '';
            if (typeof val === 'object') {
                const colorVar = colorMap[val.color] || colorMap['default'];
                displayHtml = `<span class="color-dot" style="background-color:${colorVar}"></span>${val.name}`;
                itemVal = val.name; 
            } else {
                displayHtml = val;
                itemVal = val;
            }
    
            body.innerHTML += `<tr>
                <td>${displayHtml}</td>
                <td class="remove" onclick="removeFromList('${currentListKey}','${itemVal}')"><i class="fas fa-trash"></i></td>
            </tr>`;
        });
        
        const input = document.getElementById('newListItem');
        input.value = '';
        input.onkeydown = (e) => { if(e.key === 'Enter') addToList(); };
        
        document.getElementById('modalListManager').style.display = 'flex';
    }
    
    function selectColor(color, el) {
        selectedColorTemp = color;
        document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    }
    
    function addToList() {
        const val = document.getElementById('newListItem').value.trim();
        if (!val) return;
        
        const isStatus = currentListKey.toLowerCase().includes('status');
        const isSubcat = currentListKey.includes('_'); 
        
        let list;
        if (isSubcat) {
            const [baseKey, cat] = currentListKey.split('_');
            masterLists[baseKey][cat] = masterLists[baseKey][cat] || []; 
            list = masterLists[baseKey][cat];
        } else {
            list = masterLists[currentListKey];
        }
    
        if (isStatus) {
            if(list.some(s => s.name === val)) return;
            list.push({ name: val, color: selectedColorTemp });
        } else {
            if(list.includes(val)) return;
            list.push(val);
        }
    
        // Ordenação
        list.sort((a,b) => (typeof a === 'object' ? a.name : a).localeCompare(typeof b === 'object' ? b.name : b));
        
        saveAll(); populateSelects();
        
        let genericTag;
        if(isSubcat) genericTag = 'subcategorias';
        else if(isStatus) genericTag = 'status';
        else if(currentListKey === 'setores') genericTag = 'setores'; 
        else genericTag = 'categorias';
        
        openListManager(genericTag);
    }
    
    function removeFromList(key, val) {
        const isStatus = key.toLowerCase().includes('status');
        const isSubcat = key.includes('_');
        
        let list;
        if (isSubcat) {
            const [baseKey, cat] = key.split('_');
            list = masterLists[baseKey][cat];
            if (isStatus) list = list.filter(s => s.name !== val);
            else list = list.filter(i => i !== val);
            masterLists[baseKey][cat] = list; 
        } else {
            list = masterLists[key];
            if (isStatus) masterLists[key] = list.filter(s => s.name !== val);
            else masterLists[key] = list.filter(i => i !== val);
        }
    
        saveAll(); populateSelects();
        
        let genericTag;
        if(isSubcat) genericTag = 'subcategorias';
        else if(isStatus) genericTag = 'status';
        else if(key === 'setores') genericTag = 'setores'; 
        else genericTag = 'categorias';
        openListManager(genericTag);
    }
    // --- FUNÇÕES DE BACKUP LOCAL (ARQUIVO) ---
    
    function exportLocalData() {
        const data = {
            audits,
            activities,
            maintenances,
            documents, 
            masterLists,
            exportDate: new Date().toISOString(),
            source: "local_export"
        };
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "Auditoria_Lamic_" + today() + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }
    
    function importLocalData(input) {
        const file = input.files[0];
        if (!file) return;
    
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                // Validação básica
                if (data.audits && data.masterLists) {
                    if(confirm("ATENÇÃO: Isso substituirá os dados atuais e atualizará a nuvem. Deseja continuar?")) {
                        
                        audits = data.audits || [];
                        activities = data.activities || [];
                        maintenances = data.maintenances || [];
                        documents = data.documents || []; 
                        
                        masterLists = { ...defaultMasterLists, ...data.masterLists };
                        if (Array.isArray(masterLists.mantItens)) {
                            masterLists.mantItens = defaultMasterLists.mantItens; 
                        }
                        
                        // Garante que os itens importados tenham o campo historico (vazio se não vier)
                        audits.forEach(a => a.historico = a.historico || []);
                        activities.forEach(a => a.historico = a.historico || []);
                        maintenances.forEach(m => m.historico = m.historico || []);
                        documents.forEach(d => d.historico = d.historico || []);
    
                        await saveAll(false); 
                        
                        alert("Backup local restaurado e sincronizado com a nuvem com sucesso!");
                        
                        populateSelects();
                        switchTab(currentTab); 
                        input.value = ''; 
                    }
                } else {
                    alert("O arquivo selecionado não é um backup válido deste sistema.");
                }
            } catch (err) {
                alert("Erro ao ler o arquivo: " + err.message);
            }
        };
        reader.readAsText(file);
    }
    
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    // Inicialização (garante que os selects sejam preenchidos ao carregar a página)
    document.addEventListener('DOMContentLoaded', () => {
        populateYearSelects();
        populateSelects();
    });
    
    function toggleSidebar() {
        document.body.classList.toggle('sidebar-open');
    }
    
    // Opcional: Fechar o menu ao clicar em um item no Mobile
    document.querySelectorAll('.sidebar button').forEach(button => {
        button.addEventListener('click', () => {
            if (window.innerWidth <= 1024) {
                document.body.classList.remove('sidebar-open');
            }
        });
    });

    document.onkeydown = function(event) {
        if (
            event.keyCode === 123 ||  // F12
            (event.ctrlKey && event.shiftKey && event.keyCode === 'I'.charCodeAt(0)) ||  // Ctrl + Shift + I
            (event.ctrlKey && event.shiftKey && event.keyCode === 'J'.charCodeAt(0)) ||  // Ctrl + Shift + J
            (event.ctrlKey && event.shiftKey && event.keyCode === 'C'.charCodeAt(0)) ||  // Ctrl + Shift + C
            (event.ctrlKey && event.keyCode === 'U'.charCodeAt(0)) ||  // Ctrl + U
            (event.ctrlKey && event.keyCode === 'S'.charCodeAt(0))  // Ctrl + S
        ) {
            event.preventDefault();
            return false;
        }
    };
            document.addEventListener('contextmenu', function(evento) {
                    evento.preventDefault();
                });
    
    </script>
</body>
</html>